# 引き継ぎ資料（2025-12-18）

## 今日の作業サマリー

### 完了した機能

#### 1. サークル設定変更通知
- **ファイル**: `functions/src/index.ts` - `onCircleUpdated`
- サークル設定変更時（名前、説明、カテゴリ、目標、ルール、公開設定、招待制、参加モード）にメンバーへ通知
- オーナーとAIメンバーは通知対象外

#### 2. サークル削除のソフトデリート方式
- **ファイル**: `functions/src/index.ts` - `deleteCircle`, `cleanupDeletedCircle`
- 即座にUI反映（`isDeleted: true`）→ バックグラウンドで削除
- 1万投稿以上にも対応（100件ずつ処理、自動再スケジュール）
- **Cloud Tasksキュー**: `circle-cleanup`（asia-northeast1）

#### 3. メディア投稿制限変更
- **ファイル**: `lib/shared/services/media_service.dart`
- 画像: 10MB → **5MB**
- 動画: 100MB → **30MB**
- ファイル添付: **完全削除**

#### 4. 削除済みサークルへのAI投稿スキップ
- **ファイル**: `functions/src/index.ts` - `executeCircleAIPost`
- 投稿実行前に`isDeleted`チェック、削除済みならスキップ

#### 5. ファイルサイズエラーメッセージ改善
- **ファイル**: `lib/features/post/presentation/screens/create_post_screen.dart`
- 汎用エラーではなく具体的なサイズエラーメッセージを表示

#### 6. 賞賛カウント修正（プロフィール画面）
- **ファイル**: `functions/src/index.ts` - `onReactionCreated` 
- リアクション追加時に投稿者の`totalPraises`を自動インクリメント
- 自己リアクションはカウントしない

#### 7. タスク作成時のデフォルトカテゴリ設定
- **ファイル**: 
  - `lib/shared/providers/task_screen_provider.dart` - `selectedCategoryIdProvider` 追加
  - `lib/features/tasks/presentation/screens/tasks_screen.dart` - タブ変更時にProvider更新
  - `lib/features/home/presentation/screens/main_shell.dart` - タスク作成時にProvider読み取り
- カテゴリタブ選択中にタスク作成→そのカテゴリがデフォルト選択される

---

## 技術スタック

| 項目 | 技術 |
|------|------|
| フロントエンド | Flutter (Dart) |
| バックエンド | Firebase Cloud Functions (TypeScript, Node.js 20) |
| DB | Firestore |
| ストレージ | Firebase Storage |
| AI | Google Gemini (gemini-2.0-flash) |
| タスクキュー | Cloud Tasks |
| プッシュ通知 | Firebase Cloud Messaging (FCM) |

---

## 重要なファイル

### バックエンド
- `functions/src/index.ts` - 全Cloud Functions（5300行以上）
- `firebase/firestore.indexes.json` - Firestoreインデックス

### フロントエンド
- `lib/shared/services/circle_service.dart` - サークル操作
- `lib/shared/services/media_service.dart` - メディアアップロード
- `lib/shared/models/circle_model.dart` - サークルモデル（isDeletedフィールド追加済み）
- `lib/features/circle/` - サークル関連画面

### 設計書
- `docs/design/implementation_plan.md` - 実装計画・進捗
- `docs/design/notification_feature_design.md` - 通知機能設計

---

## Cloud Functions一覧（主要）

| 関数名 | トリガー | 説明 |
|--------|----------|------|
| `deleteCircle` | onCall | サークル削除（ソフトデリート） |
| `cleanupDeletedCircle` | HTTP (Cloud Tasks) | バックグラウンド削除ワーカー |
| `onCircleUpdated` | Firestore onUpdate | 設定変更通知 |
| `onCircleCreated` | Firestore onCreate | AI自動生成 |
| `generateCircleAIPosts` | Cloud Scheduler | AI投稿スケジュール |
| `executeCircleAIPost` | HTTP (Cloud Tasks) | AI投稿実行 |
| `evolveCircleAIs` | Cloud Scheduler | AI成長イベント |

---

## 注意点

1. **Cloud Tasksキュー**
   - `ai-posts`: AI投稿用（asia-northeast1）
   - `circle-cleanup`: サークル削除用（asia-northeast1）

2. **サービスアカウント**
   - Cloud Tasks認証: `positive-sns@appspot.gserviceaccount.com`

3. **環境変数**
   - `GEMINI_API_KEY`: Secret Managerで管理
   - `GCLOUD_PROJECT`: プロジェクトID

---

## 今後の実装候補

- タスク達成自動共有（削除済み）
- サークル招待機能
- サークル内イベント機能

---

## コミット履歴（今日）

| コミット | 内容 |
|----------|------|
| `abebf7d` | ファイルサイズエラー時に具体的なメッセージを表示 |
| `93f3fab` | タスク添付ファイルのmaxFileSize参照を修正 |
| `3be3ed9` | ファイル投稿削除、メディア制限変更、削除済みサークルへのAI投稿スキップ |
| `2bb8d97` | 設計書更新（ソフトデリート対応完了） |
| `6236c0a` | cleanupDeletedCircleのリクエストボディパース修正 |
| `8a2c1a6` | サークル削除のソフトデリート方式に変更 |
