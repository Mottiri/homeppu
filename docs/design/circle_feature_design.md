# サークル機能 設計書

## 概要

サークルは、共通の目標や興味を持つユーザーが集まり、投稿や交流を行う場です。
本ドキュメントでは、既存機能と計画中の拡張機能の仕様を定義します。

---

## 1. 既存機能

### 1.1 基本情報

| 項目 | 詳細 |
|------|------|
| データモデル | `CircleModel` |
| サービス | `CircleService` |
| 画面数 | 6画面 |

### 1.2 データ構造

```typescript
// circles コレクション
{
  id: string,
  name: string,              // サークル名
  description: string,       // 説明
  category: string,          // カテゴリ
  ownerId: string,           // オーナーUID
  memberIds: string[],       // メンバーUID配列
  aiMode: 'aiOnly' | 'mix' | 'humanOnly',  // AIモード
  generatedAIs: object[],    // 生成されたAIペルソナ
  isPublic: boolean,         // 公開/非公開
  maxMembers: number,        // 最大メンバー数（デフォルト20）
  createdAt: Timestamp,
  recentActivity: Timestamp, // 最終アクティビティ（AI含む）
  lastHumanPostAt: Timestamp | null, // 人間ユーザーの最終投稿日時
  goal: string,              // サークルの目標
  coverImageUrl: string?,    // カバー画像
  iconImageUrl: string?,     // アイコン画像
  memberCount: number,       // メンバー数
  postCount: number,         // 投稿数
  rules: string?,            // サークルルール（500文字以内）
  isDeleted: boolean,        // ソフトデリート済み
}
```

### 1.3 画面構成

| 画面 | ファイル | 機能 |
|------|----------|------|
| サークル一覧 | `circles_screen.dart` | カテゴリフィルタ、検索、参加サークル表示 |
| サークル詳細 | `circle_detail_screen.dart` | 投稿表示、ピン留め、メンバー管理 |
| サークル作成 | `create_circle_screen.dart` | 新規作成フォーム |
| サークル編集 | `edit_circle_screen.dart` | 設定変更（オーナーのみ） |
| 参加申請管理 | `join_requests_screen.dart` | 承認/拒否（オーナー・副オーナー） |
| メンバー一覧 | `members_list_screen.dart` | メンバーリスト表示 |

### 1.4 機能一覧

#### オーナー機能

| 機能 | 状態 | 備考 |
|------|------|------|
| サークル作成 | ✅ 実装済 | |
| サークル編集 | ✅ 実装済 | 名前、説明、カテゴリ、公開設定等 |
| サークル削除 | ✅ 実装済 | Cloud Function経由、カスケード削除 |
| 参加申請承認/拒否 | ✅ 実装済 | 通知送信付き |
| 投稿ピン留め | ✅ 実装済 | 通常ピン + トップピン |
| AIモード設定 | ✅ 実装済 | AIのみ/ミックス/人間のみ |

#### メンバー機能

| 機能 | 状態 | 備考 |
|------|------|------|
| サークル検索 | ✅ 実装済 | 名前検索 |
| 参加申請 | ✅ 実装済 | 非公開サークル用 |
| 直接参加 | ✅ 実装済 | 公開サークル用 |
| 脱退 | ✅ 実装済 | |
| 投稿作成 | ✅ 実装済 | サークル内投稿 |

#### 未実装機能

| 機能 | 優先度 | 備考 |
|------|--------|------|
| 副オーナー | ✅ 実装済 | 下記参照 |
| 投票機能 | 中 | 投稿内投票 |
| メンバー追放 | 不要 | 通報で対応 |

---

## 2. 副オーナー機能（実装済）

### 2.1 概要

オーナー不在時のサークル運営を補助するため、副オーナーを1名設定可能とする。

### 2.2 権限比較

| 機能 | オーナー | 副オーナー | 一般メンバー |
|------|---------|-----------|------------|
| 投稿ピン留め | ✅ | ✅ | ❌ |
| メンバー承認/拒否 | ✅ | ✅ | ❌ |
| サークル編集 | ✅ | ❌ | ❌ |
| サークル削除 | ✅ | ❌ | ❌ |
| 副オーナー任命/解任 | ✅ | ❌ | ❌ |
| 他者投稿削除（UI） | ❌ | ❌ | ❌ |

※他者投稿削除は管理者のみ（通報経由で対応）

### 2.3 仕様

| 項目 | 仕様 |
|------|------|
| 人数 | 1名のみ |
| 任命方法 | オーナーが任命 or メンバーから立候補申請 |
| 解任 | オーナーのみ可能 |
| オーナー不在時 | 自動でオーナーに昇格 |

### 2.4 データ構造変更

```diff
// circles コレクション
{
  ownerId: string,
+ subOwnerId: string | null,  // 副オーナーUID
  memberIds: string[],
}
```

---

## 3. 管理者権限（実装済）

### 3.1 サークルに対する管理者権限

管理者は全サークルに対してオーナー同等の権限を持つ。

| 機能 | 管理者 | 実装状況 |
|------|--------|----------|
| サークル内投稿（未参加でも） | ✅ | 未参加でもFAB表示 |
| 投稿ピン留め | ✅ | オーナー/副オーナーと同等 |
| サークル編集 | ✅ | UIメニューからアクセス可 |
| サークル削除 | ✅ | UIメニューからアクセス可 |
| 参加申請承認/拒否 | ✅ | 申請一覧画面から操作可 |
| 参加申請バッジ表示 | ✅ | サークル一覧で確認可 |
| 投稿削除 | ✅ | `deletePost`参照（以前から実装済） |

### 3.2 BAN時のサークル対応

| シナリオ | 対応 |
|---------|------|
| オーナーが一時BAN | 副オーナーがいれば通知、いなければ管理者が対応 |
| オーナーが永久BAN | 副オーナーがオーナーに自動昇格 |
| オーナー＆副オーナー両方BAN | サークル自動削除、メンバーに通知 |
| 一時BANから復帰 | 副オーナーに降格（現オーナーが許可すればオーナーに復帰可） |

---

## 4. AIモード

### 4.1 モード種類

| モード | 説明 |
|--------|------|
| `aiOnly` | AI投稿のみ許可（人間不可） |
| `mix` | AI・人間両方可 |
| `humanOnly` | 人間投稿のみ許可（AI不可） |

### 4.2 AI投稿生成

- Cloud Functionsでスケジュール実行
- サークル専用AIペルソナを生成可能
- 詳細: [circle_ai_post_design.md](./circle_ai_post_design.md)

---

## 5. 活動状態管理（実装済）

### 5.1 概要

サークルの活動状態を可視化し、管理者がゴーストサークルを判別できるようにする。

### 5.2 アクティビティ表示

| 表示対象 | フィールド | 表示場所 |
|---------|-----------|----------|
| 全ユーザー | `recentActivity` | サークルカードに「X日前に投稿あり」 |
| 管理者のみ | `lastHumanPostAt` | サークルカードに「人間: X日前」 |

### 5.3 判定基準

| 経過時間 | 表示 | 色 |
|---------|------|----|
| 7日以内 | 🔥 アクティブ | 緑 |
| 7日以上 | 🕐 非アクティブ | グレー |
| 投稿なし | 🕐 まだ投稿なし | 薄いグレー |

### 5.4 更新タイミング

| イベント | 更新フィールド |
|---------|---------------|
| 人間ユーザー投稿 | `recentActivity`, `lastHumanPostAt`, `postCount` |
| AI投稿（将来対応） | `recentActivity` のみ |

### 5.5 マイグレーション

既存サークルの`lastHumanPostAt`を設定するスクリプト:
```bash
cd functions
node scripts/migrate_last_human_post.js
```

---

## 6. 並び順・フィルター機能（実装済）

### 6.1 概要

サークル一覧画面で並び順の変更とフィルタリングが可能。

### 6.2 並び順オプション

| オプション | 説明 | ソートキー |
|------------|------|-----------|
| 🕐 新着順（デフォルト） | 作成日が新しい順 | `createdAt` DESC |
| 🔥 アクティブ順 | 最終投稿が新しい順 | `recentActivity` DESC |
| 👥 人気順 | 参加人数が多い順 | `memberCount` DESC |
| 📝 投稿数順 | 投稿が多い順 | `postCount` DESC |
| 👤 人間投稿古い順 | 管理者のみ | `lastHumanPostAt` ASC |

### 6.3 フィルターオプション

| オプション | 説明 | 条件 |
|------------|------|------|
| 空きあり | 満員でないサークル | `memberCount < maxMembers` |
| 投稿あり | 投稿があるサークル | `postCount > 0` |

### 6.4 UI配置

タブセレクター（みんなの/参加中）とカテゴリチップの間にドロップダウン2つを配置。

---

## 7. 関連ファイル

### クライアント

| ファイル | 説明 |
|----------|------|
| `lib/shared/models/circle_model.dart` | データモデル |
| `lib/shared/services/circle_service.dart` | サービス層 |
| `lib/features/circle/presentation/screens/` | 画面群 |

### Cloud Functions

| 関数 | 説明 |
|------|------|
| `deleteCircle` | サークル削除（カスケード） |
| `approveCircleJoin` | 参加承認 |
| `rejectCircleJoin` | 参加拒否 |
| `generateCircleAIPosts` | サークルAI投稿生成 |

### セキュリティルール

| ファイル | 関連セクション |
|----------|----------------|
| `firebase/firestore.rules` | `/circles/{circleId}` |

---

## 8. 今後の拡張

| 機能 | 優先度 | 状態 |
|------|--------|------|
| 副オーナー機能 | ✅ 実装済 | 完了 |
| 並び順・フィルター | ✅ 実装済 | 完了 |
| 定期クリーンアップ | 中 | 検討中 |
| 投票機能（投稿内） | 中 | 検討中 |
| サークル招待 | 低 | 未検討 |

---

## 更新履歴

- 2026-01-03: 初版作成 - 既存機能の洗い出し、副オーナー・BAN連携仕様追加
- 2026-01-04: 副オーナー機能実装完了（任命UI、通知、参加申請権限、バッジ表示）
- 2026-01-04: 管理者権限実装完了（サークル編集/削除、参加申請管理、バッジ表示）
- 2026-01-07: 活動状態管理機能追加（`lastHumanPostAt`フィールド、管理者向け表示）
- 2026-01-07: 並び順・フィルター機能追加（5種類の並び順、2種類のフィルター）
