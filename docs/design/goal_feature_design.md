# 目標機能 (Goal Feature) 設計書

## 1. 概要
ユーザーが長期的な「目標」を設定し、日々の「タスク」をその目標に紐付けることで、達成感と継続性を高める機能。
目標の達成度合いや進捗を可視化し、モチベーション維持を支援する。

## 2. データモデル (GoalModel)

| フィールド名 | 型 | 説明 |
| :--- | :--- | :--- |
| `id` | String | 目標の一意なID (UUID) |
| `userId` | String | 所有者のユーザーID |
| `title` | String | 目標のタイトル (必須) |
| `description` | String | 目標の詳細・メモ (任意) |
| `deadline` | DateTime? | 達成期限 (任意) |
| `colorValue` | int | テーマカラー (ARGB int) |
| `status` | String | ステータス ('active', 'completed', 'archived') |
| `createdAt` | DateTime | 作成日時 |
| `updatedAt` | DateTime | 更新日時 |
| `completedAt` | DateTime? | 達成日時 |
| `isPublic` | bool | 公開設定 (将来的なSNS機能用。現在はデフォルトfalse) |

### 関連モデルへの影響
*   **TaskModel**: `goalId` フィールドを追加。タスクがどの目標に属するかを管理。

## 3. 機能仕様

### 3.1 目標の作成 (Create)
*   **場所**: 目標一覧画面の「＋」ボタン (FAB)。
*   **入力項目**:
    *   タイトル (必須)
    *   詳細 (任意)
    *   期限 (任意) - カレンダーで日付と時刻を選択。
    *   カラー (任意) - プリセットから選択。
    *   公開設定 (任意) - トグルスイッチ。
*   **挙動**: 作成と同時にFirestoreに保存され、一覧に追加される。

### 3.2 目標の一覧表示 (Read)
*   **場所**: タスク画面右上の旗アイコンから遷移する「目標一覧画面」。
*   **表示内容**:
    *   **進行中の目標**: カード形式で表示。色は設定したテーマカラー。
    *   **殿堂入り (Archive)**: 達成済みの目標を格納する折りたたみセクション。
*   **表示要素**: タイトル、期限までの残り時間、進捗状況（視覚的表現）。

### 3.3 タスクとの連携 (Linking)
*   **タスク作成時**:
    *   「新しいタスク」追加シート（BottomSheet）に「目標に関連付ける?」セレクターを表示。
    *   進行中の目標のみ選択可能。
*   **仕様**:
    *   1つのタスクは1つの目標にのみ紐付く (N:1)。
    *   繰り返しタスクの場合、生成される全てのインスタンスが同じ `goalId` を持つ。

### 3.4 目標の達成 (Completion)
*   **場所**: 目標詳細画面の「目標を達成する！」ボタン。
*   **挙動**:
    *   ステータスを `completed` に変更し、`completedAt` を記録。
    *   **クリーンアップ**: この目標に紐付いている**未完了の未来のタスク**（繰り返し生成分など）を自動的に削除するか確認し、削除する。
    *   一覧画面では「殿堂入り」セクションへ移動。

### 3.5 目標の削除 (Delete)
*   **場所**: 目標詳細画面の削除ボタン。
*   **挙動**:
    *   目標ドキュメントを削除。
    *   **カスケード削除**: この目標に紐付いている全てのタスク（過去・現在・未来）も同時に削除する（確認ダイアログあり）。

## 4. UI/UX デザイン

### 4.1 ナビゲーション
*   以前のボトムナビゲーション案を廃止。
*   **タスク画面**の右上（カレンダーアイコンの横）に配置した旗アイコン（🏳️）を入り口とする。
*   目標機能はタスク管理の「上位概念」または「拡張機能」という位置付け。

### 4.2 ビジュアル表現
*   **彩度 (Saturation)**: (将来実装予定) 目標の達成に近づくにつれて、またはタスクを消化するにつれて、目標カードの色が鮮やかになる等の視覚的フィードバックを想定（現在は基本カラー表示のみ）。

### 4.3 目標カード内タスク表示 (実装済み)
*   **表示内容**: 目標に紐付いたタスクを目標カード内に一覧表示。
    *   未完了タスクが上、完了タスクが下（ソート済み）。
    *   各タスクに完了状態を示すチェックアイコン。
    *   サブタスクがある場合は「0/3」形式のバッジを表示。
*   **インタラクション**:
    *   **タスク行タップ**: タスク画面へ遷移し、該当日付のタスクをハイライト表示（パルスアニメーション付き）。
    *   **サブタスクバッジタップ**: サブタスク一覧を展開/折りたたみ。
    *   **チェックアイコンタップ**: タスクの完了/未完了を切り替え。
    *   **サブタスク行タップ**: 個別サブタスクの完了/未完了を切り替え。
*   **ハイライト表示**: 遷移先のタスクは動的アニメーション（パルス＋グロー）で強調表示され、タップまたは3秒後に解除。

## 5. 今後の拡張予定 (TODO)
*   **カレンダー連携**: カレンダー上の該当日にフラグを表示。
*   **編集機能**: タイトルや期限の修正。
*   **統計**: 達成率のグラフ化。

## 6. 目標達成時の自動投稿 ✅ (2025-12-28)

### 6.1 概要
目標に紐付いたタスクをすべて完了し、目標進捗が100%になった際に、自動でお祝い投稿を作成する機能。

### 6.2 トリガー条件
*   タスク完了時に `goalId` が設定されている
*   `GoalService.getGoalProgress` で完了タスク数 + 1（今回完了分）>= 全タスク数

### 6.3 投稿内容
```
🎉 目標「{目標名}」を達成しました！おめでとうございます！
```

### 6.4 UI演出
*   紙吹雪アニメーション（ConfettiWidget）
*   称賛Snackbar表示

### 6.5 技術詳細
*   投稿作成: `PostService.createTaskCompletionPost` → `AIService.createPostWithRateLimit`（Cloud Functions経由）
*   投稿削除: タスク完了取り消し時、自動投稿も削除
*   参照: `task_feature_design.md` セクション13

## 7. 目標リマインダー通知 ✅ (2025-12-28)

### 7.1 概要
目標の期限に対して事前通知と期限時刻通知を送信する機能。

### 7.2 データ構造
`GoalModel.reminders` に以下の形式で保存:
```json
[
  {"value": 1, "unit": "days"},
  {"value": 3, "unit": "hours"},
  {"value": 30, "unit": "minutes"}
]
```

### 7.3 通知の種類
| 通知タイプ | タイトル | 本文例 | タイミング |
|-----------|---------|--------|-----------| 
| 事前リマインダー | 🚩 目標リマインダー | 「目標名」の期限まで1日です | 設定した事前時間 |
| 期限時刻通知 | 🚩 目標の期限です！ | 「目標名」の期限になりました。達成状況を確認しましょう！ | 期限時刻ちょうど |

### 7.4 技術実装（イベント駆動方式）
*   **Cloud Tasks**: `task-reminders` キューでリマインダーをスケジュール
*   **Firestore Triggers**:
    *   `scheduleGoalRemindersOnCreate`: 目標作成時にリマインダーを登録
    *   `scheduleGoalReminders`: 目標更新時に古いリマインダーをキャンセル→新規登録
*   **HTTP Endpoint**: `executeGoalReminder` - Cloud Tasksから呼び出されて通知送信
*   **重複防止**: `sentReminders` コレクションで送信済みを記録
*   **スケジュール管理**: `scheduledReminders` コレクションでCloud Tasks名を記録

### 7.5 実装ステータス
- [x] 事前リマインダー通知 ✅
- [x] 期限時刻通知 ✅
- [x] 分/時間/日単位の選択 ✅
- [x] 重複送信防止 ✅

## 8. UI改善 (2025-12-28)

### 8.1 期限設定の時刻対応
*   日付選択後に**時刻選択ダイアログ**を表示
*   表示フォーマット: `yyyy/MM/dd HH:mm`
*   デフォルト日時: **現在の日時**（作成時のタイミング）

### 8.2 公開設定の削除
*   **理由**: 他ユーザーへの公開機能が未実装のため、UIから公開設定トグルを削除
*   **データ**: `GoalModel.isPublic` フィールドは維持（将来的なSNS機能用、デフォルトfalse）

### 8.3 カラーオプションの整理
*   黄色（イエロー）を削除（視認性の問題）
*   利用可能カラー: コーラル、ピーチ、グリーン、ブルー、パープル、ピンク、ティール

### 8.4 その他修正 (2025-12-28)
*   **目標詳細画面**: 期限および達成日の表示を「日付のみ」から「日付 + 時刻 (`yyyy/MM/dd HH:mm`)」に変更。
*   **自動投稿**: 目標達成時の自動投稿で、目標タイトルが正しく引用されるよう修正。

