# サークル機能設計書 (v5)

## 1. 概要
「同じ目標を持つ仲間」が集まり、励まし合いながら継続するための機能。
**チャットではなく「サークル内フィード」形式**で実装する。
TLとの差別化を図り、「閉じられた安心感」のあるUIを提供する。

---

## 2. 画面構成

### 2.1 サークルトップ画面（一覧）
**アクセス**: ボトムナビの「サークル」タブ

| 要素 | 説明 |
|------|------|
| 検索バー | サークル名で検索 |
| カテゴリチップ | 横スクロールでカテゴリ選択（勉強、ダイエット、趣味など） |
| サークル一覧 | カード形式で表示 |

**サークルカードの表示内容**:
- サークルアイコン
- サークル名
- 説明（1-2行）
- カテゴリバッジ
- メンバー数
- 投稿数

### 2.2 サークル詳細画面
**アクセス**: サークルカードをタップ

| 要素 | 説明 |
|------|------|
| ヘッダー画像 | サークルのカバー画像 |
| サークルアイコン | ヘッダー下部に重ねて表示 |
| サークル名 | |
| メンバー数・カテゴリ | |
| 参加ボタン | 未参加時に表示 |
| 投稿一覧 | サークル内の投稿（フィード形式） |
| ピン留め投稿 | 管理者がピン留めした投稿を上部に表示 |

### 2.3 サークル作成画面
- サークル名
- 説明
- カテゴリ選択
- カバー画像
- アイコン画像
- AIモード選択（AIモード/ミックス/人間のみ）
- 公開設定（公開/招待のみ）**※AIモード時は非表示**

### 2.4 AIモードサークルの仕様
| 設定 | AIモード | Mix/人間モード |
|------|----------|----------------|
| 一覧表示 | 作成者のみ | 全員 |
| 公開設定 | 不要（常に非公開） | 必要 |
| 参加 | 作成者専用 | 公開→誰でも / 招待→申請 |

---

## 3. ユーザーフロー

### 3.1 参加フロー
```
サークル一覧 → カードタップ → 詳細画面 → 参加ボタン
                                          ↓
                              ┌─────────────────────┐
                              │ 公開サークル         │ → 即参加
                              │ 招待制サークル       │ → 参加申請ダイアログ
                              └─────────────────────┘
```

### 3.2 招待制サークルの申請フロー
1. 参加ボタンをタップ
2. 「参加申請を送信しますか？」ダイアログ
3. 管理者に通知
4. 管理者が許可/拒否
5. 結果をユーザーに通知

### 3.3 参加申請の管理
**管理者限定機能として表示箇所を検討**:
- サークル詳細画面の「管理」タブ
- または設定アイコンからアクセス

### 3.4 サークル削除フロー

**削除権限**: オーナーのみ

**削除フロー**:
1. サークル詳細画面 → 設定/管理メニュー → 「サークルを削除」
2. 削除確認ダイアログ表示
   - 削除理由入力欄（任意）
   - 「削除すると元に戻せません」警告
3. 削除実行

**関連データの削除**:
- サークル内投稿（posts where circleId = xxx）
- 参加申請（circleJoinRequests where circleId = xxx）
- 投稿に関連するコメント・リアクション

**メンバーへの通知**:
| 削除理由 | 通知内容 |
|----------|----------|
| あり | 「○○サークルが削除されました。理由: △△」 |
| なし | 「○○サークルが削除されました」 |

**通知方法**: プッシュ通知 + アプリ内通知（両方）
- プッシュ通知: 削除をすぐに知らせる
- アプリ内通知: 通知アイコン内で詳細確認可能

---

## 4. サークル投稿

### 4.1 サークル投稿 vs メイン投稿
| 項目 | サークル投稿 | メイン投稿 |
|------|-------------|-----------|
| 表示場所 | サークル内のみ | メインTL |
| AIコメント | サークルAIが対応 | 通常AI |
| 投稿ボタン | サークル画面では自動でサークル投稿に切り替え | |

---

## 5. サークルAIモード詳細設計

### 5.1 概要
サークルAIモードは、サークルの目的・説明を理解した専用AIが参加するモード。
一般AIと異なり、サークルのテーマに沿った投稿・コメントができる。

**一般AI vs サークルAI:**
| 項目 | 一般AI | サークルAI |
|------|--------|-----------|
| コンテキスト | 投稿内容のみ | サークル名 + 説明 + 投稿内容 |
| 専門性 | 汎用的（浅い） | 特化型（深い） |
| コメント例 | 「すごい！頑張ったね！」 | 「俺まだ1500ダメ！追いつくぞ！」 |

### 5.2 AI生成
- **生成タイミング**: サークル作成時に自動生成
- **AI数**: 3体固定（全モード共通）
- **メンバー数反映**: AIもメンバーとしてカウント

### 5.3 AIペルソナ設計
```
【基本設定】
- サークルの「仲間」として振る舞う
- 必ず「初心者〜中級者」レベル（上から目線を防ぐ）
- 投稿者を追いかける立場（「すごい！俺も頑張る」）

【避けるべき設定】
- 専門家・プロ設定（AIバレしやすい）
- 完璧な知識を持つ設定（不自然）
```

**ペルソナ例（APEXサークル）:**
| AI名 | 設定 | コメント傾向 |
|------|------|-------------|
| がんばる🎮 | APEX歴2ヶ月、まだブロンズ | 「まじすごい！俺もブロンズ抜けたい」 |
| のんびり🐱 | 週末だけプレイ、ゴールド | 「お〜いいね！今度一緒にやりたい」 |
| 熱血ファイター | 毎日練習中、プラチナ目指し中 | 「最高！俺も負けてられん💪」 |

### 5.4 テーマ抽出（プロンプト精度向上）
サークル説明からAIが自動でテーマ・レベル感・雰囲気を抽出する。

**抽出対象:**
- サークル名
- サークル説明
- カテゴリ

**AIプロンプト例:**
```
【サークル情報】
名前: APEXうまくなる！
カテゴリ: ゲーム
説明: APEX初心者がうまくなるためのサークル。ランクはブロンズ〜シルバーが多いです

→ AIは「APEX」「初心者」「ブロンズ〜シルバー」をキーワードとして抽出
→ 専門用語（ダメージ、キル数、ランク等）を自然に使える
```

### 5.5 AI投稿機能
| 項目 | 内容 |
|------|------|
| 投稿頻度 | 1日1〜2回（サークルあたり） |
| 投稿内容 | サークルテーマに沿った「頑張り報告」 |
| トリガー | Cloud Scheduler（定期実行） |
| 特徴 | 「完璧じゃない」「成長途中」を演出してリアリティを出す |

**投稿例（APEXサークル）:**
```
AI「がんばる🎮」の投稿:
「今日も練習してきた！2試合で1キルしかできなかったけど、
昨日より動きは良くなった気がする🔥明日も頑張る！」
```

### 5.6 AI成長演出
AIが時間経過で成長する演出を実装。

**成長ルール:**
- 成長は「ユーザーの平均よりやや遅い」ペース
- 最大でも「中級者」まで（プロにはならない）
- 成長イベントは1ヶ月に1回程度

**例（APEXサークル）:**
| 期間 | AIのレベル |
|------|-----------|
| 初期 | ブロンズ4 |
| 1ヶ月後 | ブロンズ2 |
| 3ヶ月後 | シルバー4 |
| 上限 | ゴールド帯（これ以上成長しない） |

→ ユーザーが「追い越せる」存在のまま維持

### 5.7 モード切替時の挙動
AIはどのモードでも維持され、強制退会はしない。

| 切替パターン | AI挙動 | 人間メンバー |
|-------------|--------|-------------|
| AI → MIX | そのまま活動継続 | 新規参加可能に |
| AI → 人間 | そのまま活動継続 | 新規参加可能に |
| MIX/人間 → AI | そのまま活動継続 | 既存メンバーは残る、新規参加不可 |

**設定変更時の通知:**
- メンバー全員に通知を送信
- 通知内容: 「🔔 サークル『○○』の設定が変更されました」

### 5.8 実装ロードマップ

| フェーズ | 内容 | 状態 |
|---------|------|------|
| MVP | サークル作成時にAI3体自動生成、コメント機能 | ✅ 完了 |
| v1.1 | AI投稿機能（9/20時トリガー→Cloud Tasksで0～3時間後にランダム投稿） | ✅ 完了 |
| v1.2 | AI成長演出（毎月1日、80%確率、上限Lv5） | ✅ 完了 |

---


## 6. 通知

| 通知タイプ | 説明 | ON/OFF |
|-----------|------|--------|
| 新しい投稿 | サークル内に新しい投稿があった時 | ○ |
| コメント | 自分の投稿にコメントがついた時 | ○ |
| 参加申請 | 管理者向け | - |
| 申請結果 | 許可/拒否の結果 | - |
| サークル削除 | サークルが削除された時 | - |

---

## 7. 退会・削除

### 7.1 メンバー退会
- サークルからメンバー数が減るだけ
- 過去の投稿はそのまま残る

### 7.2 オーナー退会
**フロー**:
1. 退会ダイアログ表示
2. 選択肢:
   - 別のオーナーを指名して退会
   - サークル自体を削除
3. サークル削除の場合 → 全メンバーに通知

---

## 8. データ構造 (Firestore Schema)

### `circles` (Collection)
| Field | Type | Description |
|-------|------|-------------|
| id | string | サークルID |
| name | string | サークル名 |
| description | string | 説明 |
| category | string | カテゴリ |
| coverImageUrl | string | カバー画像URL |
| iconImageUrl | string | アイコン画像URL |
| aiMode | string | `ai_only` / `mix` / `human_only` |
| isPublic | boolean | `true`: 公開 / `false`: 招待制 |
| ownerId | string | オーナーのユーザーID |
| memberIds | array\<string\> | メンバーIDリスト |
| memberCount | number | メンバー数 |
| postCount | number | 投稿数 |
| generatedAIs | array | 生成されたAI情報 |
| createdAt | timestamp | 作成日時 |

### `circleJoinRequests` (Collection)
| Field | Type | Description |
|-------|------|-------------|
| id | string | 申請ID |
| circleId | string | サークルID |
| userId | string | 申請者ID |
| status | string | `pending` / `approved` / `rejected` |
| createdAt | timestamp | 申請日時 |

### `posts` (Extension)
| Field | Type | Description |
|-------|------|-------------|
| circleId | string? | サークルID（null = メインTL） |

---

## 9. 実装ステップ

### Phase 1: 基盤 ✅ 完了
1. [x] Circleモデル作成
2. [x] CircleService作成
3. [x] Firestoreルール追加

### Phase 2: UI（閲覧）✅ 完了
4. [x] サークルトップ画面（一覧）
5. [x] サークル詳細画面
6. [x] サークル検索・フィルター
7. [x] シアンカラーテーマ適用
8. [x] 招待制バッジ表示

### Phase 3: UI（操作）✅ 完了
9. [x] サークル作成画面
10. [x] 参加・退会機能
11. [x] 参加申請ダイアログ
12. [x] 中央ボタン変更（サークル画面対応）

### Phase 4: 投稿 ✅ 完了
13. [x] サークル投稿機能
14. [x] メインTLからサークル投稿を分離
15. [x] 投稿カウント更新（作成・削除時）
16. [x] メンバーのみFAB表示

### Phase 5: AI ✅ 完了
17. [x] サークルAI生成（usersテーブル、コメント対応）
18. [x] AI投稿機能（9AM/8PM定期実行、Gemini生成）
19. [x] AI成長システム（毎月1日、上限Lv5）

### Phase 6: 管理 ✅ 完了
19. [x] 管理者機能（申請管理画面）
20. [x] 申請の承認・拒否処理
21. [x] ピン留め投稿（トップ表示、一覧ボトムシート）
22. [x] 通知機能（オーナーへの申請通知、申請者への結果通知）
23. [x] サークル削除機能（Cloud Function、削除理由・メンバー通知）
24. [x] 重複申請防止（申請中状態表示）
25. [x] サークル一覧UI改善（タブ、オーナーバッジ、申請バッジ）
26. [x] サークル編集機能（名前・説明・カテゴリ・目標・ルール・公開設定）
27. [x] サークルルール機能（参加時同意ダイアログ、ルール確認ボタン）
28. [x] メンバー一覧画面（オーナーバッジ、プロフィール遷移）

---

## 10. 残り実装項目

✅ **すべて完了**

- ~~**サークルAI**: AIメンバー生成、自動投稿~~ → ✅ 完了
- ~~**サークル設定変更通知**: 設定変更時にメンバーへ通知~~ → ✅ 完了
- ~~**大規模サークル削除**: ソフトデリート + バックグラウンド削除（1万投稿以上対応）~~ → ✅ 完了

---

## 11. UI/UXガイドライン

- ほめっぷのコンセプトに合った**おしゃれで洗練された、かわいい**デザイン
- 既存画面との統一感を維持
- サークル画面は**シアン（#00ACC1）**をアクセントカラーとして使用
- 参考画像のレイアウトを参考にしつつ、独自のスタイルを適用

---

## 12. 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-12-18 | メディア制限変更（画像5MB、動画30MB）、ファイル投稿削除、サイズエラー表示改善 |
| 2025-12-18 | サークル削除をソフトデリート方式に変更（1万投稿以上対応、バックグラウンド削除） |
| 2025-12-18 | サークル設定変更通知実装（onCircleUpdated、8種類の設定変更を検出して通知） |
| 2025-12-18 | AI投稿ランダム時間化（Cloud Tasks対応、0～3時間分散） |
| 2025-12-18 | サークルAI v1.1/v1.2実装完了（定期AI投稿、月一回成長イベント） |
| 2025-12-18 | サークルAI MVP実装完了（usersテーブル作成、AI3体自動生成、サークルコンテキスト対応コメント） |
| 2025-12-18 | サークルAIモード詳細設計追加（ペルソナ、成長演出、モード切替、テーマ抽出） |
| 2025-12-18 | サークル管理機能完了（編集、ルール、メンバー一覧、ピン留め投稿） |
| 2025-12-17 | サークル申請管理機能完成（承認/拒否、通知、プロフィール遷移、UI改善） |
| 2025-12-17 | サークル削除機能実装（Cloud Function、メンバー通知、関連データ削除） |
| 2025-12-17 | AIモードサークル仕様追加（作成者専用、公開設定非表示） |
| 2025-12-16 | Phase 1-4完了、シアンテーマ、中央ボタン、招待制対応 |

