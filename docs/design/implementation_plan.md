# サークル機能設計書 (v5)

## 1. 概要
「同じ目標を持つ仲間」が集まり、励まし合いながら継続するための機能。
**チャットではなく「サークル内フィード」形式**で実装する。
TLとの差別化を図り、「閉じられた安心感」のあるUIを提供する。

---

## 2. 画面構成

### 2.1 サークルトップ画面（一覧）
**アクセス**: ボトムナビの「サークル」タブ

| 要素 | 説明 |
|------|------|
| 検索バー | サークル名で検索 |
| カテゴリチップ | 横スクロールでカテゴリ選択（勉強、ダイエット、趣味など） |
| サークル一覧 | カード形式で表示 |

**サークルカードの表示内容**:
- サークルアイコン
- サークル名
- 説明（1-2行）
- カテゴリバッジ
- メンバー数
- 投稿数

### 2.2 サークル詳細画面
**アクセス**: サークルカードをタップ

| 要素 | 説明 |
|------|------|
| ヘッダー画像 | サークルのカバー画像 |
| サークルアイコン | ヘッダー下部に重ねて表示 |
| サークル名 | |
| メンバー数・カテゴリ | |
| 参加ボタン | 未参加時に表示 |
| 投稿一覧 | サークル内の投稿（フィード形式） |
| ピン留め投稿 | 管理者がピン留めした投稿を上部に表示 |

### 2.3 サークル作成画面
- サークル名
- 説明
- カテゴリ選択
- カバー画像
- アイコン画像
- AIモード選択（AIモード/ミックス/人間のみ）
- 公開設定（公開/招待のみ）**※AIモード時は非表示**

### 2.4 AIモードサークルの仕様
| 設定 | AIモード | Mix/人間モード |
|------|----------|----------------|
| 一覧表示 | 作成者のみ | 全員 |
| 公開設定 | 不要（常に非公開） | 必要 |
| 参加 | 作成者専用 | 公開→誰でも / 招待→申請 |

---

## 3. ユーザーフロー

### 3.1 参加フロー
```
サークル一覧 → カードタップ → 詳細画面 → 参加ボタン
                                          ↓
                              ┌─────────────────────┐
                              │ 公開サークル         │ → 即参加
                              │ 招待制サークル       │ → 参加申請ダイアログ
                              └─────────────────────┘
```

### 3.2 招待制サークルの申請フロー
1. 参加ボタンをタップ
2. 「参加申請を送信しますか？」ダイアログ
3. 管理者に通知
4. 管理者が許可/拒否
5. 結果をユーザーに通知

### 3.3 参加申請の管理
**管理者限定機能として表示箇所を検討**:
- サークル詳細画面の「管理」タブ
- または設定アイコンからアクセス

### 3.4 サークル削除フロー

**削除権限**: オーナーのみ

**削除フロー**:
1. サークル詳細画面 → 設定/管理メニュー → 「サークルを削除」
2. 削除確認ダイアログ表示
   - 削除理由入力欄（任意）
   - 「削除すると元に戻せません」警告
3. 削除実行

**関連データの削除**:
- サークル内投稿（posts where circleId = xxx）
- 参加申請（circleJoinRequests where circleId = xxx）
- 投稿に関連するコメント・リアクション

**メンバーへの通知**:
| 削除理由 | 通知内容 |
|----------|----------|
| あり | 「○○サークルが削除されました。理由: △△」 |
| なし | 「○○サークルが削除されました」 |

**通知方法**: プッシュ通知 + アプリ内通知（両方）
- プッシュ通知: 削除をすぐに知らせる
- アプリ内通知: 通知アイコン内で詳細確認可能

---

## 4. サークル投稿

### 4.1 サークル投稿 vs メイン投稿
| 項目 | サークル投稿 | メイン投稿 |
|------|-------------|-----------|
| 表示場所 | サークル内のみ | メインTL |
| AIコメント | サークルAIが対応 | 通常AI |
| 投稿ボタン | サークル画面では自動でサークル投稿に切り替え | |

---

## 5. AIの詳細

### 5.1 生成数
- **2〜3名程度**（20名制限を圧迫しない）
- サークル作成時に自動生成

### 5.2 AI投稿
- **Cloud Schedulerで自動投稿**
- 投稿頻度: **1日 1〜2件程度**
- ランダムなAIがランダムな時間差で投稿
- 運用しながら調整

### 5.3 サークルAIの生成
- **既存AIアカウントとは別に生成**
- サークルのタイトル・説明をプロンプトに含める
- 属性（性別、年齢層、性格）はランダム振り分け

---

## 6. 通知

| 通知タイプ | 説明 | ON/OFF |
|-----------|------|--------|
| 新しい投稿 | サークル内に新しい投稿があった時 | ○ |
| コメント | 自分の投稿にコメントがついた時 | ○ |
| 参加申請 | 管理者向け | - |
| 申請結果 | 許可/拒否の結果 | - |
| サークル削除 | サークルが削除された時 | - |

---

## 7. 退会・削除

### 7.1 メンバー退会
- サークルからメンバー数が減るだけ
- 過去の投稿はそのまま残る

### 7.2 オーナー退会
**フロー**:
1. 退会ダイアログ表示
2. 選択肢:
   - 別のオーナーを指名して退会
   - サークル自体を削除
3. サークル削除の場合 → 全メンバーに通知

---

## 8. データ構造 (Firestore Schema)

### `circles` (Collection)
| Field | Type | Description |
|-------|------|-------------|
| id | string | サークルID |
| name | string | サークル名 |
| description | string | 説明 |
| category | string | カテゴリ |
| coverImageUrl | string | カバー画像URL |
| iconImageUrl | string | アイコン画像URL |
| aiMode | string | `ai_only` / `mix` / `human_only` |
| isPublic | boolean | `true`: 公開 / `false`: 招待制 |
| ownerId | string | オーナーのユーザーID |
| memberIds | array\<string\> | メンバーIDリスト |
| memberCount | number | メンバー数 |
| postCount | number | 投稿数 |
| generatedAIs | array | 生成されたAI情報 |
| createdAt | timestamp | 作成日時 |

### `circleJoinRequests` (Collection)
| Field | Type | Description |
|-------|------|-------------|
| id | string | 申請ID |
| circleId | string | サークルID |
| userId | string | 申請者ID |
| status | string | `pending` / `approved` / `rejected` |
| createdAt | timestamp | 申請日時 |

### `posts` (Extension)
| Field | Type | Description |
|-------|------|-------------|
| circleId | string? | サークルID（null = メインTL） |

---

## 9. 実装ステップ

### Phase 1: 基盤 ✅ 完了
1. [x] Circleモデル作成
2. [x] CircleService作成
3. [x] Firestoreルール追加

### Phase 2: UI（閲覧）✅ 完了
4. [x] サークルトップ画面（一覧）
5. [x] サークル詳細画面
6. [x] サークル検索・フィルター
7. [x] シアンカラーテーマ適用
8. [x] 招待制バッジ表示

### Phase 3: UI（操作）✅ 完了
9. [x] サークル作成画面
10. [x] 参加・退会機能
11. [x] 参加申請ダイアログ
12. [x] 中央ボタン変更（サークル画面対応）

### Phase 4: 投稿 ✅ 完了
13. [x] サークル投稿機能
14. [x] メインTLからサークル投稿を分離
15. [x] 投稿カウント更新（作成・削除時）
16. [x] メンバーのみFAB表示

### Phase 5: AI ⏳ 未実装
17. [ ] サークルAI生成
18. [ ] AI投稿機能（管理者限定）

### Phase 6: 管理 ⏳ 一部実装
19. [ ] 管理者機能（申請管理画面）
20. [ ] 申請の承認・拒否処理
21. [ ] ピン留め投稿
22. [ ] 通知機能
23. [x] サークル削除機能（Cloud Function、削除理由・メンバー通知）

---

## 10. 残り実装項目

### 優先度高
- **参加申請管理画面**: オーナーが申請一覧を確認、承認/拒否
- **通知機能**: 申請受信、承認/拒否結果をユーザーに通知

### 優先度中
- **ピン留め投稿**: 管理者が投稿を上部に固定
- **サークル編集**: 名前・説明・設定の変更

### 優先度低
- **サークルAI**: AIメンバー生成、自動投稿
- **タスク達成自動共有**: タスク完了時にサークルへ自動投稿

---

## 11. UI/UXガイドライン

- ほめっぷのコンセプトに合った**おしゃれで洗練された、かわいい**デザイン
- 既存画面との統一感を維持
- サークル画面は**シアン（#00ACC1）**をアクセントカラーとして使用
- 参考画像のレイアウトを参考にしつつ、独自のスタイルを適用

---

## 12. 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-12-17 | サークル削除機能実装（Cloud Function、メンバー通知、関連データ削除） |
| 2025-12-17 | AIモードサークル仕様追加（作成者専用、公開設定非表示） |
| 2025-12-16 | Phase 1-4完了、シアンテーマ、中央ボタン、招待制対応 |

