# プロフィール機能設計書

## 1. 概要
ユーザー自身の情報管理、設定変更、および他ユーザーの情報閲覧を行う機能。
「マイページ」としての機能と、「他ユーザープロフィール」としての機能を兼ね備える。

## 2. 画面構成 (UI Layout)

### 2.1 ヘッダー (SliverAppBar)
*   **高さ**: Expanded Height 200px
*   **構成**:
    *   **背景画像**: ヘッダー上部150pxに表示（現在はグラデーションで代用）。
    *   **アバター**: ヘッダー下部中央に配置。サイズ100px。画像とコンテンツの境界にオーバーラップさせる。
    *   **アクションボタン**:
        *   戻るボタン（他人表示時）
        *   設定ボタン（自分表示時）
        *   管理者メニュー（管理者表示時）

### 2.2 プロフィール情報 (SliverToBoxAdapter)
*   **表示名**: アバターの下に大きく表示。
*   **統計情報**: 投稿数、称賛数、徳ポイントなど。
*   **自己紹介**: バイオグラフィー。
*   **フォローボタン**: 他ユーザー表示時のみ。
*   **BAN警告**: 必要に応じて表示。

### 2.3 コンテンツエリア (SliverPersistentHeader + SliverList)
*   **タブバー**: 「おすすめ」「フォロー中」などを切り替え。
*   **投稿リスト**: 無限スクロール対応。

## 3. 機能仕様 (Functionality)

### 3.1 ユーザーデータの読み込み
*   `userId` 引数が `null` または現在ユーザーと一致の場合、「自分モード」として動作（`currentUserProvider` を監視）。
*   異なる `userId` の場合、Firestoreからユーザー情報を一度だけ取得（リアルタイム監視はしない）。

### 3.2 フォロー機能
*   `FollowService` を使用。
*   フォロー/フォロー解除のアクションを提供。
*   optimistic UIによる即時反映。

### 3.3 ヘッダー画像機能 (2026-01-06 追加)
プロフィール画面上部に表示されるヘッダー画像を設定する機能。

#### 3.3.1 デフォルト画像
*   6種類の波形デザイン画像（`assets/images/headers/header_wave_1-6.png`）から選択可能。
*   設定画面で横スクロールのグリッドから選択。
*   選択した画像のインデックスは`headerImageIndex`に保存。

#### 3.3.2 カスタム画像
*   ユーザーが任意の画像をアップロード可能。
*   NSFWモデレーション（`NsfwDetectorService`）によるチェック。
*   Firebase Storageの`headers/{uid}.jpg`に保存。
*   画像URLは`headerImageUrl`に保存。

#### 3.3.3 色抽出・連動
*   `palette_generator`パッケージを使用して画像から色を抽出。
*   抽出した色は`headerPrimaryColor`と`headerSecondaryColor`に保存。
*   アバター枠、フォローボタン、メッセージボタン、投稿カテゴリタブの色が連動。

### 3.4 設定画面 (SettingsScreen)
マイページ右上の設定ボタンから遷移。

#### 3.4.1 通知設定
*   **コメント通知**: ON/OFF
*   **リアクション通知**: ON/OFF

#### 3.4.2 自動投稿設定 (2025-12-28 追加)
*   **ストリーク達成時**: マイルストーン達成時の自動投稿 ON/OFF。
*   **目標達成時**: 目標クリア時の自動投稿 ON/OFF。
*   ※ OFFの場合も、画面上の演出（紙吹雪など）は行われる。

#### 3.4.3 公開範囲設定 (`postMode`)
*   デフォルトの投稿公開範囲を設定。
    *   **全公開 (Public)**
    *   **フォロワー限定 (Followers)** (未実装/将来予定)
    *   **自分のみ (Private)**

#### 3.4.4 アカウント管理
*   **ログアウト**: 確認ダイアログを経てログアウト。
*   **アカウント削除**: 退会処理。

## 4. データモデル (User Model)

### 4.1 主要フィールド (`UserModel`)
| フィールド名 | 型 | 説明 |
| :--- | :--- | :--- |
| `uid` | String | ユーザーID |
| `displayName` | String | 表示名 |
| `avatarIndex` | int | アバター画像のインデックス |
| `bio` | String? | 自己紹介文 |
| `virtue` | int | 徳ポイント |
| `notificationSettings` | Map | 通知設定フラグ |
| `autoPostSettings` | Map | 自動投稿設定フラグ (`milestones`, `goals`) |
| `isBanned` | bool | アカウント制限状態 |
| `headerImageUrl` | String? | カスタムヘッダー画像URL |
| `headerImageIndex` | int? | デフォルトヘッダー画像のインデックス（0-5） |
| `headerPrimaryColor` | int? | ヘッダー画像から抽出したメイン色（ARGB） |
| `headerSecondaryColor` | int? | ヘッダー画像から抽出したサブ色（ARGB） |

## 5. デザイン・UX方針
*   **暖色系グラデーション**: `AppColors.warmGradient` を背景に使用し、親しみやすさを演出。
*   **プル更新**: 投稿リストは下方向へのプルで更新可能（`RefreshIndicator` - 未実装だがリストの挙動として想定）。
*   **無限スクロール**: 投稿リストはページング読み込みに対応。
*   **ヘッダー画像連動**: ヘッダー画像の色に合わせてUIのアクセントカラーが動的に変化。
