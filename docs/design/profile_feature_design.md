# プロフィール機能設計書

## 1. 概要
ユーザー自身の情報管理、設定変更、および他ユーザーの情報閲覧を行う機能。
「マイページ」としての機能と、「他ユーザープロフィール」としての機能を兼ね備える。

## 2. 画面構成 (UI Layout)

### 2.1 ヘッダー (AppBar)
*   **タイトル**:
    *   自分: 「マイページ」
    *   他人: 「プロフィール」
*   **アクション**:
    *   **戻るボタン**: 他ユーザー表示時のみ（または画面遷移履歴がある場合）。
    *   **設定ボタン** (⚙️): 自分のプロフィール時のみ表示。`SettingsScreen` へ遷移。
    *   **管理者機能**: 特定の管理者UIDの場合のみ、レビュー画面へのリンクを表示。

### 2.2 プロフィールカード
*   **アバター**: `AvatarWidget` を使用して表示。
*   **表示名**: `UserModel.displayName`。
*   **フォローボタン**:
    *   他ユーザーの場合のみ表示。
    *   フォロー中/フォローする のトグルボタン。
*   **自己紹介 (Bio)**: 設定されている場合のみ表示。
*   **統計情報**:
    *   **投稿**: `totalPosts`
    *   **称賛**: `totalPraises` (獲得した称賛数)
    *   **徳ポイント**: 詳細は `VirtueIndicator` (自分のみ) または数値表示 (他人)。
*   **BAN警告**: アカウントが制限されている場合、警告メッセージを表示。

### 2.3 コンテンツエリア
*   **フォロー中リスト**: 自分のプロフィールかつフォロー中ユーザーがいる場合、アバターリストを横スクロール表示。
*   **投稿リスト**: タブ切り替え式。
    *   **TL**: タイムライン投稿 (サークル以外)。
    *   **サークル**: 所属サークルの投稿。
    *   **お気に入り**: お気に入り登録した投稿 (自分のみ、または公開設定による - 現状は自分のみ挙動)。

## 3. 機能仕様 (Functionality)

### 3.1 ユーザーデータの読み込み
*   `userId` 引数が `null` または現在ユーザーと一致の場合、「自分モード」として動作（`currentUserProvider` を監視）。
*   異なる `userId` の場合、Firestoreからユーザー情報を一度だけ取得（リアルタイム監視はしない）。

### 3.2 フォロー機能
*   `FollowService` を使用。
*   フォロー/フォロー解除のアクションを提供。
*   optimistic UIによる即時反映。

### 3.3 設定画面 (SettingsScreen)
マイページ右上の設定ボタンから遷移。

#### 3.3.1 通知設定
*   **コメント通知**: ON/OFF
*   **リアクション通知**: ON/OFF

#### 3.3.2 自動投稿設定 (2025-12-28 追加)
*   **ストリーク達成時**: マイルストーン達成時の自動投稿 ON/OFF。
*   **目標達成時**: 目標クリア時の自動投稿 ON/OFF。
*   ※ OFFの場合も、画面上の演出（紙吹雪など）は行われる。

#### 3.3.3 公開範囲設定 (`postMode`)
*   デフォルトの投稿公開範囲を設定。
    *   **全公開 (Public)**
    *   **フォロワー限定 (Followers)** (未実装/将来予定)
    *   **自分のみ (Private)**

#### 3.3.4 アカウント管理
*   **ログアウト**: 確認ダイアログを経てログアウト。
*   **アカウント削除**: 退会処理。

## 4. データモデル (User Model)

### 4.1 主要フィールド (`UserModel`)
| フィールド名 | 型 | 説明 |
| :--- | :--- | :--- |
| `uid` | String | ユーザーID |
| `displayName` | String | 表示名 |
| `avatarIndex` | int | アバター画像のインデックス |
| `bio` | String? | 自己紹介文 |
| `virtue` | int | 徳ポイント |
| `notificationSettings` | Map | 通知設定フラグ |
| `autoPostSettings` | Map | 自動投稿設定フラグ (`milestones`, `goals`) |
| `isBanned` | bool | アカウント制限状態 |

## 5. デザイン・UX方針
*   **暖色系グラデーション**: `AppColors.warmGradient` を背景に使用し、親しみやすさを演出。
*   **プル更新**: 投稿リストは下方向へのプルで更新可能（`RefreshIndicator` - 未実装だがリストの挙動として想定）。
*   **無限スクロール**: 投稿リストはページング読み込みに対応。
