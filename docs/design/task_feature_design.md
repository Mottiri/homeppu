# タスク機能設計書 (v2)

## 1. 概要
ユーザーが日々の目標を管理し、達成を積み上げるためのコア機能。
**「サークルとの連携」「公開範囲の細分化」「メディア記録（Proof of Work）」**を追加し、
「見られているから頑張れる」モチベーションと、「記録する楽しさ」を提供する。

## 2. 既存仕様（現状）
*   **タスク種類**: `daily` (繰り返し), `goal` (期限付き)
*   **基本機能**: 作成・編集・削除・達成（チェック）・ストリーク・徳ポイント

## 3. 追加仕様: 公開範囲と共有 (Visibility & Sharing)

### 3.1 共有ロジック
タスクごとに「どこに共有するか」を細かく制御できる。

| 公開設定 (`isPublic`) | 共有先指定 (`shareTo`) | 挙動 |
|---|---|---|
| **OFF** | - | **非公開**。自分だけの記録。どこにも通知されない。 |
| **ON** | 指定サークルIDあり | **指定サークルのみ**に投稿される。<br>（例: 「ダイエットサークル」にだけ体重記録を共有） |
| **ON** | 指定なし (Empty) | **全体（一般タイムライン）**に投稿される。<br>（例: 誰でも見れるオープンな成果報告） |

### 3.2 データ構造 (Updated Schema)
`TaskModel` への追加フィールド:

| Field | Type | Default | Description |
|---|---|---|---|
| `isPublic` | boolean | `false` | 公開するかどうかのマスタースイッチ |
| `shareToCircleIds` | List<String> | `[]` | 共有するサークルのIDリスト。<br>空かつisPublic=trueなら「全体公開」扱い。 |

## 4. 追加仕様: 達成の記録 (Proof of Work)

### 4.1 コンセプト
「勉強したノート」や「ジムの風景」など、画像の記録をタスク完了時に添付できる。
**「手軽さ」と「リッチさ」を両立するUI**を採用する。

### 4.2 UXフロー (2段階達成アクション)
1.  **通常タップ（ワンタップ）**:
    *   **「手軽に完了」**
    *   画像なし。テキストのみの自動投稿（または投稿なし）を行う。
    *   忙しい時や、記録する画像がない時用。

2.  **長押し（またはサブボタン）**:
    *   **「証拠画像付きで完了」**
    *   カメラ/アルバム選択が立ち上がる。
    *   画像や動画を選択してアップロード → タスク完了＆画像付き投稿を作成。
    *   「今日は頑張ったから見て！」という時用。

### 4.3 投稿データの扱い
*   画像付き完了の場合、生成される `Post` データに `imageUrls` が含まれる。
*   タイムライン上では通常の「画像付き投稿」と同様に表示され、AIや他ユーザーがコメントできる。

## 5. UI/UX 変更点

### 5.1 タスク作成/編集ダイアログ
*   **公開スイッチ**: ON/OFF
*   **共有先選択**:
    *   初期表示: 「全体に公開」
    *   タップすると「共有するサークルを選択」ダイアログ表示（チェックボックス形式）。

### 5.2 タスクリスト画面
*   **タスクカード**:
    *   タップ領域: 完了トグル
    *   長押し領域: 全体（「画像を記録して完了」メニュー表示、または直接カメラ起動）
    *   インジケーター: 公開中タスクには「目のアイコン」、サークル限定なら「サークルアイコン」などを小さく表示。

## 6. 実装ステップ
1.  **Model更新**: `TaskModel` に `isPublic`, `shareToCircleIds` を追加。
2.  **UI更新 (作成)**: タスク作成ダイアログに公開・共有先設定を追加。
3.  **UI更新 (リスト)**: タスクリスト項目の長押しジェスチャー (`onLongPress`) を実装。
4.  **ロジック実装**:
    *   画像アップロード処理 (Storage)
    *   自動投稿生成処理 (`PostRepository.createPost`)
    *   Cloud Functions連携（必要であれば通知周り等）
