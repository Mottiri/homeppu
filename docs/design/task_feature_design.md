# タスク機能設計書 (v3)

## 1. 概要
ユーザーが日々の目標を管理し、達成を積み上げるためのコア機能。
**「サークルとの連携」「公開範囲の細分化」「メディア記録（Proof of Work）」**に加え、**「快適な操作性（Optimistic UI）」**を重視する。

## 2. タスク区分（Updated）
ユーザーのメンタルモデルに合わせて整理。

| 区分 | 内部ID | 説明 | 備考 |
|---|---|---|---|
| **通常タスク** | `todo` | 一般的なタスク。 | デフォルト |
| **カテゴリタスク** | - | ユーザー作成のカテゴリに属するタスク。 | |
| ~~**デイリー**~~ | - | (廃止) 通常タスクの繰り返し設定で代用。 | |

## 3. スケジュール管理 (Time Management)

### 3.1 データ構造
`TaskModel` の主要フィールド:

| Field | Description |
|---|---|
| `recurrenceInterval`, `recurrenceUnit` | 繰り返し設定（毎日, 毎週, 毎月）。Googleカレンダー連携は廃止し、アプリ内完結型へ移行。 |
| `priority` | 優先度 (0:低, 1:中, 2:高)。 |
| `subtasks` | サブタスクリスト。 |
| `isCompleted`, `lastCompletedAt` | 完了状態管理。 |

### 3.2 UI/UX (Current)
*   **タスクカードデザイン**:
    *   **通常モード**:
        *   **左側**: 余白のみ（チェックボックスなし）。
        *   **右側**: 「完了」ボタン（未完了時） / 「戻す」ボタン（完了時）。
        *   **アクション**: 「完了」ボタンタップで**即時反映（Optimistic UI）**。
    *   **編集モード**:
        *   **左側**: 選択用チェックボックス（24px, Square）。
        *   **右側**: アイコン類は非表示。
        *   **アクション**: カード全体タップで選択トグル。
*   **週間カレンダー**:
    *   **日付移動**: タップで瞬時に日付切り替え（アニメーションなし）。
    *   **今日に戻る**: ボタンで瞬時に今週・今日へ復帰。

## 4. 削除機能とUX
*   **削除フロー**:
    *   **スワイプ削除**: 編集モード時のみ有効。
    *   **一括削除**: 複数選択して削除ボタン。
*   **確認ダイアログ**:
    *   通常タスク: 削除確認のみ。
    *   繰り返しタスク: 「今回のみ削除」であることを明記。
    *   **永続化オプション**: 「今後表示しない」チェックボックスを実装済み（`SharedPreferences`）。
*   **Optimistic UI（楽観的UI）導入済み**:
    *   削除・完了操作は、サーバー通信を待たずにUIから即時反映。
    *   通信エラー時のみロールバック＆SnackBar通知。
    *   これにより「連打」や「消えない」ストレスを解消。

## 5. 公開範囲と共有 (Visibility & Sharing)
*   **公開設定**: `isPublic` フラグにより、サークルまたは全体への共有を制御（実装済み）。
*   **達成の記録**: 画像付きで完了する機能（Proof of Work）をサポート。

## 6. タスク詳細と拡張 (Implemented)
*   **メモ**:
    *   タスク作成・詳細画面でテキストメモを追加可能。
    *   URLリンクなどはテキストとして保存。
    *   完了ボタン付きキーボードで入力スムーズ化。
*   **画像添付**:
    *   タスクに画像を複数枚添付可能（Firebase Storage）。
    *   サムネイル表示＆タップでフルスクリーンプレビュー。
    *   削除操作はUI上のみ（ファイルは維持）。
    *   **繰り返し時の挙動**: 未来の繰り返しタスク生成時、**添付ファイルは引き継がない**（リセットされる）。

## 7. 繰り返しタスクの挙動詳細
*   **変更時のダイアログ**:
    *   **ルール変更時**: 「間隔」「曜日」などを変更した場合のみ、「これ以降も変更しますか？」ダイアログを表示。
    *   **内容変更時**: タイトル、メモ、サブタスク完了などの変更は、**ダイアログなしで「今回のタスクのみ」に保存**される。
*   **生成ロジック**:
    *   **メモ**: 未来のタスクにも引き継がれる。
    *   **サブタスク**: 項目名は引き継がれるが、**完了状態はすべて未完了（リセット）**状態で生成される。

## 8. UX改善 (Edit Mode & Delete)
*   **編集モード中の操作**:
    *   **スワイプ削除**: **無効化**（誤操作防止）。
    *   **ページ移動**: 画面スワイプで日付（ページ）移動が可能。
*   **削除ロジック（堅牢性）**:
    *   **冪等性**: 万が一、既に削除されたタスクを再度削除しようとしてもエラーにならないよう、セキュリティルールとクライアントロジックを調整済み。
    *   **選択解除**: スワイプ削除時など、削除されたタスクは即座に選択リストから除外される。

## 9. 目標（Goal）と達成感の可視化 (Future Work)
*   **コンセプト**: 「進捗バー」や「カレンダー」ではなく、**「彩り（Saturation）」**で積み上げを表現する。
*   **UIイメージ**:
    *   **Goal Card**: 大きなカードとして表示。
    *   **Visual Feedback**:
        *   初期状態: モノクロ、または薄い色のカード。
        *   タスク達成時: 紐づいたタスクを完了するたびに、カードの色が鮮やかになる（彩度が上がる）。
        *   **「色付いていく」**ことで、努力が形になる過程を直感的に楽しめるデザイン。
    *   **カレンダー不要**: 目標詳細画面では日付カレンダーは強調せず、この「カードの変化」と「紐づいたタスク一覧」をメインにする。

