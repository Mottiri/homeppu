# タスク機能設計書 (v2)

## 1. 概要
ユーザーが日々の目標を管理し、達成を積み上げるためのコア機能。
**「サークルとの連携」「公開範囲の細分化」「メディア記録（Proof of Work）」**を追加し、
「見られているから頑張れる」モチベーションと、「記録する楽しさ」を提供する。

## 2. タスク区分（Updated）
ユーザーのメンタルモデルに合わせて3つの区分に整理する。

| 区分 | 内部ID (`TaskType`) | 説明 | カレンダー連携 |
|---|---|---|---|
| **デイリー** | `daily` | 毎日やる習慣・ルーティン。<br>（例: 筋トレ、サプリ飲む、勉強） | 毎日繰り返し登録 |
| **やること（中期）** | `todo` (New) | 期間や期限が決まっているタスク。<br>（例: プレゼン資料作成、買い物、旅行の準備） | **日時指定で登録** |
| **目標（長期）** | `goal` | 長期的に達成したい大きな目標。<br>（例: 年内に資格取得、5kg痩せる） | 期限日を登録 |

## 3. 追加仕様: スケジュール管理 (Time Management)

### 3.1 データ構造
`TaskModel` への追加フィールド:

| Field | Type | Default | Description |
|---|---|---|---|
| `priority` | int | `0` | 優先度 (0:低, 1:中, 2:高)。<br>UIでは色やアイコンで表現。 |
| `subtasks` | List<TaskItem> | `[]` | サブタスク（チェックリスト）。<br>構造: `{id, title, isCompleted}` |

### 3.2 UI/UX (Updated)
*   **タスクカードデザイン**:
    *   **見た目**: シンプルなカード型。
    *   **情報量**: タイトル、期限、優先度（色）、サブタスク進捗（例: `1/3` のアイコン）。
    *   **サブタスクの表示**:
        *   カード内には**展開せず、進捗のみ表示**（リストが長くなりすぎるのを防ぐため）。
        *   タップすると詳細画面（ボトムシート）が開き、そこでチェックや追加を行う。
*   **作成フロー (Quick Add)**:
    *   **「サクッと作成」を再重視**: FABを押すと、画面下部に小さな入力欄が出現。
    *   必須は**タイトル入力のみ**。
    *   その場で「明日やる」「優先度高」などをアイコンタップで付与可能だが、基本は文字打ってEnterで即保存。
*   **編集・削除**:
    *   カードをタップ → **詳細ボトムシート**起動。
    *   ここでカレンダー連携、サブタスク編集、削除などがフルに行える。

## 4. 追加仕様: Googleカレンダー連携 (Google Calendar Sync)

### 4.1 コンセプト
ポジティブなSNSだが、実用的なツールとしての側面を強化。予定を入れることで実行率を高める。

### 4.2 技術要件
*   **パッケージ**: `google_sign_in`, `googleapis`
*   **スコープ**: `CalendarApi.calendarEventsScope`
*   **認証フロー**:
    1.  ユーザーはEmailでログイン済み。
    2.  タスク作成時（または設定画面）で「Googleカレンダー連携」ボタンを押す。
    3.  `google_sign_in` を呼び出し、Googleアカウントで認証（OAuthトークン取得）。
    4.  取得したトークンを使って `CalendarApi` を初期化し、イベントを作成。

### 4.3 連携フロー
1.  **タスク保存時**:
    *   `scheduledAt` があり、かつ「連携ON」の場合。
    *   GoogleカレンダーAPIを叩いてイベント作成。
        *   Title: タスクのタイトル
        *   Description: メモ + "Created via Homeppu"
        *   Start/End: `scheduledAt` (デフォルトで1時間または30分枠)
        *   **Reminders**: デフォルト設定を使用 (`useDefault: true`)、または明示的に通知を追加（例: 15分前）。
            *   これにより、**アプリ側で通知機能を実装せずとも、Googleカレンダーアプリから通知が届く**ようになります。
    *   返却された `eventId` をFirestoreのタスクにも保存。
2.  **タスク更新時**:
    *   `googleCalendarEventId` があれば、カレンダー側も更新。
4.  **タスク削除時**:
    *   カレンダー側のイベントも削除するか確認（または自動削除）。

### 4.4 環境設定＆トラブルシューティング (Configuration)
Google連携を動作させるために必要な設定項目（ハマりどころ）:

1.  **SHA-1フィンガープリントの登録**:
    *   開発環境(debug)と本番環境(release)それぞれのSHA-1をFirebase Consoleに登録必須。
    *   特にAndroid Studioのbundled JDKを使用している場合、ターミナルからの `gradlew signingReport` が `JAVA_HOME` エラーになることがあるため、IDE内のGradleタスク実行機能を使うか、パスを一時的に通して取得する。
2.  **Google認証プロバイダの有効化**:
    *   Firebase Authentication > Sign-in method で「Google」を有効にする必要がある。
    *   **重要**: 有効化後に `google-services.json` を再ダウンロードしないと、`oauth_client` 情報が欠落してエラーになる。
3.  **OAuth同意画面の設定**:
    *   Google Cloud Consoleで「外部 (External)」ユーザータイプを選択し、「テスト (Testing)」モードにする。
    *   **ユーザーサポートメール** と **デベロッパーの連絡先情報** は必須（未設定だとエラー10の原因になる）。
    *   **テストユーザーの追加**: テストモードの場合、使用するGoogleアカウント（メールアドレス）を「テストユーザー」リストに手動で追加する必要がある（これがないとError 403: Access Deniedになる）。
4.  **Google Calendar APIの有効化**:
    *   Google Cloud ConsoleのAPIライブラリで、該当プロジェクトに対して「Google Calendar API」を有効にする必要がある。

## 5. 追加仕様: 公開範囲と共有 (Visibility & Sharing)

### 3.1 共有ロジック
タスクごとに「どこに共有するか」を細かく制御できる。

| 公開設定 (`isPublic`) | 共有先指定 (`shareTo`) | 挙動 |
|---|---|---|
| **OFF** | - | **非公開**。自分だけの記録。どこにも通知されない。 |
| **ON** | 指定サークルIDあり | **指定サークルのみ**に投稿される。<br>（例: 「ダイエットサークル」にだけ体重記録を共有） |
| **ON** | 指定なし (Empty) | **全体（一般タイムライン）**に投稿される。<br>（例: 誰でも見れるオープンな成果報告） |

### 3.2 データ構造 (Updated Schema)
`TaskModel` への追加フィールド:

| Field | Type | Default | Description |
|---|---|---|---|
| `isPublic` | boolean | `false` | 公開するかどうかのマスタースイッチ |
| `shareToCircleIds` | List<String> | `[]` | 共有するサークルのIDリスト。<br>空かつisPublic=trueなら「全体公開」扱い。 |

## 4. 追加仕様: 達成の記録 (Proof of Work)

### 4.1 コンセプト
「勉強したノート」や「ジムの風景」など、画像の記録をタスク完了時に添付できる。
**「手軽さ」と「リッチさ」を両立するUI**を採用する。

### 4.2 UXフロー (2段階達成アクション)
1.  **通常タップ（ワンタップ）**:
    *   **「手軽に完了」**
    *   画像なし。テキストのみの自動投稿（または投稿なし）を行う。
    *   忙しい時や、記録する画像がない時用。

2.  **長押し（またはサブボタン）**:
    *   **「証拠画像付きで完了」**
    *   カメラ/アルバム選択が立ち上がる。
    *   画像や動画を選択してアップロード → タスク完了＆画像付き投稿を作成。
    *   「今日は頑張ったから見て！」という時用。

### 4.3 投稿データの扱い
*   画像付き完了の場合、生成される `Post` データに `imageUrls` が含まれる。
*   タイムライン上では通常の「画像付き投稿」と同様に表示され、AIや他ユーザーがコメントできる。

## 5. UI/UX 変更点

### 5.1 タスク作成/編集ダイアログ
*   **公開スイッチ**: ON/OFF
*   **共有先選択**:
    *   初期表示: 「全体に公開」
    *   タップすると「共有するサークルを選択」ダイアログ表示（チェックボックス形式）。

### 5.2 タスクリスト画面
*   **タスクカード**:
    *   タップ領域: 完了トグル
    *   長押し領域: 全体（「画像を記録して完了」メニュー表示、または直接カメラ起動）
    *   インジケーター: 公開中タスクには「目のアイコン」、サークル限定なら「サークルアイコン」などを小さく表示。

## 6. 実装ステップ
1.  **Model更新**: `TaskModel` に `isPublic`, `shareToCircleIds`, `priority`, `subtasks` を追加。
    *   `scheduledAt` 等も含む。
2.  **UI更新 (Quick Add)**: 現在のダイアログを廃止し、**「ライトな入力ボトムシート」**を作成。
3.  **UI更新 (Task Detail)**: タスクタップ時の**「詳細編集ボトムシート」**を作成（サブタスク管理含む）。
4.  **ロジック実装**:
    *   Google連携
    *   画像アップロード
5.  **ウィジェット開発 (Home Widget)**:
    *   ネイティブコード(Kotlin/Swift)が必要。
    *   `home_widget` パッケージを選定。
    *   今日のタスク一覧を表示。
