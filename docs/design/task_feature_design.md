# タスク機能設計書 (v3)

## 1. 概要
ユーザーが日々の目標を管理し、達成を積み上げるためのコア機能。
**「サークルとの連携」「公開範囲の細分化」「メディア記録（Proof of Work）」**に加え、**「快適な操作性（Optimistic UI）」**を重視する。

## 2. タスク区分（Updated）
ユーザーのメンタルモデルに合わせて整理。

| 区分 | 内部ID | 説明 | 備考 |
|---|---|---|---|
| **通常タスク** | `todo` | 一般的なタスク。 | デフォルト |
| **カテゴリタスク** | - | ユーザー作成のカテゴリに属するタスク。 | |
| ~~**デイリー**~~ | - | (廃止) 通常タスクの繰り返し設定で代用。 | |

## 3. スケジュール管理 (Time Management)

### 3.1 データ構造
`TaskModel` の主要フィールド:

| Field | Description |
|---|---|
| `recurrenceInterval`, `recurrenceUnit` | 繰り返し設定（毎日, 毎週, 毎月）。Googleカレンダー連携は廃止し、アプリ内完結型へ移行。 |
| `priority` | 優先度 (0:低, 1:中, 2:高)。 |
| `subtasks` | サブタスクリスト。 |
| `isCompleted`, `lastCompletedAt` | 完了状態管理。 |

### 3.2 UI/UX (Current)
*   **タスクカードデザイン**:
    *   **通常モード**:
        *   **左側**: 余白のみ（チェックボックスなし）。
        *   **右側**: 「完了」ボタン（淡い緑色）/ 完了済みアイコン（緑チェック）。
        *   **アクション**: 「完了」ボタンタップで**即時反映（Optimistic UI）**。
        *   **情報アイコン**: タスク名の下に表示
            *   🔔 リマインダーアイコン（事前通知設定時、オレンジ色）
            *   🔁 繰り返しアイコン（繰り返し設定時）
            *   📝 メモアイコン + 30文字抜粋（メモあり時）
            *   🖼️ 画像サムネイル（36x36px）+ 枚数バッジ（画像添付時、タップで拡大）
    *   **編集モード**:
        *   **左側**: 選択用チェックボックス（24px, Square）。
        *   **右側**: アイコン類は非表示。
        *   **アクション**: カード全体タップで選択トグル。

> [!WARNING]
> **開発者向け注意**: `TaskCard` ウィジェット（`task_card.dart`）には**2つの重複したコードパス**があります。
> - `buildContent()` 関数（354-598行）: ハイライト時（`isHighlighted=true`）に使用
> - インラインコード（694-1021行）: 通常時に使用
> 
> UI変更時は**両方のコードパスに同じ変更を適用**する必要があります。
*   **FAB（タスク追加ボタン）**:
    *   **スクロール連動**: スクロールダウンでFABが縮小して非表示、スクロールアップで再表示（X/Twitter風アニメーション）。
    *   **目的**: タスクの完了ボタンとFABの重なりを防止。
    *   **色**: プライマリカラー（コーラル/ピンク）。
*   **週間カレンダー**:
    *   **日付移動**: タップで瞬時に日付切り替え（アニメーションなし）。
    *   **今日に戻る**: ボタンで瞬時に今週・今日へ復帰。

## 4. 削除機能とUX
*   **削除フロー**:
    *   **スワイプ削除**: 編集モード時のみ有効。
    *   **一括削除**: 複数選択して削除ボタン。
*   **確認ダイアログ**:
    *   通常タスク: 削除確認のみ。
    *   繰り返しタスク: 「今回のみ削除」であることを明記。
    *   **永続化オプション**: 「今後表示しない」チェックボックスを実装済み（`SharedPreferences`）。
*   **Optimistic UI（楽観的UI）導入済み**:
    *   削除・完了操作は、サーバー通信を待たずにUIから即時反映。
    *   通信エラー時のみロールバック＆SnackBar通知。
    *   これにより「連打」や「消えない」ストレスを解消。

## 5. 公開範囲と共有 (Visibility & Sharing)
*   **公開設定**: `isPublic` フラグにより、サークルまたは全体への共有を制御（実装済み）。
*   **達成の記録**: 画像付きで完了する機能（Proof of Work）をサポート。

## 6. タスク詳細と拡張 (Implemented)
*   **メモ**:
    *   タスク作成・詳細画面でテキストメモを追加可能。
    *   URLリンクなどはテキストとして保存。
    *   完了ボタン付きキーボードで入力スムーズ化。
*   **画像添付**:
    *   タスクに画像を複数枚添付可能（Firebase Storage）。
    *   サムネイル表示＆タップでフルスクリーンプレビュー。
    *   削除操作はUI上のみ（ファイルは維持）。
    *   **繰り返し時の挙動**: 未来の繰り返しタスク生成時、**添付ファイルは引き継がない**（リセットされる）。

## 7. 繰り返しタスクの挙動詳細
*   **変更時のダイアログ**:
    *   **ルール変更時**: 「間隔」「曜日」などを変更した場合、「これ以降も変更しますか？」ダイアログを表示。
    *   **通知設定変更時**: リマインダーの追加・変更・削除時も、「これ以降も変更しますか？」ダイアログを表示。
    *   **内容変更時**: タイトル、メモ、サブタスク完了などの変更は、**ダイアログなしで「今回のタスクのみ」に保存**される。
*   **生成ロジック**:
    *   **メモ**: 未来のタスクにも引き継がれる。
    *   **サブタスク**: 項目名は引き継がれるが、**完了状態はすべて未完了（リセット）**状態で生成される。

## 8. UX改善 (Edit Mode & Delete)
*   **編集モード中の操作**:
    *   **スワイプ削除**: **無効化**（誤操作防止）。
    *   **ページ移動**: 画面スワイプで日付（ページ）移動が可能。
*   **削除ロジック（堅牢性）**:
    *   **冪等性**: 万が一、既に削除されたタスクを再度削除しようとしてもエラーにならないよう、セキュリティルールとクライアントロジックを調整済み。
    *   **選択解除**: スワイプ削除時など、削除されたタスクは即座に選択リストから除外される。

## 9. 目標（Goal）機能詳細仕様 (Approved)

### 9.1 概要
*   **コンセプト**: 「彩り（Saturation）」で積み上げを表現する。
*   **画面構成**:
    *   **目標タブ**: タスク一覧とは別に独立したタブ（または画面）。
    *   **アーカイブ**: 完了した目標は画面最下部の「殿堂入り（Completed）」エリアに格納される。展開していつでも閲覧可能。

### 9.2 データ構造と連携
*   **Goal - Task連携**:
    *   目標に「繰り返しタスク（の親）」を紐付けることが可能。
    *   日々のタスクを完了すると、自動的に目標の「実績」として蓄積される。
    *   **カレンダー表示**: 目標に期限がある場合、カレンダーには「ゴールフラッグ（🚩）」などの特別なアイコンで表示。
*   **繰り返しタスクの表示最適化**:
    *   **フィルタリング**: 繰り返しグルーピングされたタスクは、**「直近の未完了タスク」1つのみ**を表示（すべて完了時は直近の完了タスク）。
    *   これにより、未来の繰り返し分（大量のタスク）でカードが埋め尽くされるのを防ぐ。
    *   **表示要素**: タイトル横に繰り返しアイコン（🔁）を表示し、単発タスクと区別。タスクスケジュール日付（M/d）も表示。

### 9.3 完了ロジック（重要）
*   **手動完了**: 期限に関わらず、ユーザーが任意のタイミングで「達成」ボタンを押せる。
*   **完了時の挙動**:
    *   **ダイアログ警告**: 「未完了の未来タスク（紐付いている繰り返し分）」が残っている場合、「これらは削除されますがよろしいですか？」と確認。
    *   **YES**: 未来のタスクを全て削除し、目標を「殿堂入り」へ移動。
*   **未完了への復帰（Revert）**:
    *   「殿堂入り」から「未完了」に戻すことが可能。
    *   **注意**: 完了時に削除された「未来のタスク」は**復活しない**（必要なら再登録）。
    *   **彩り**: 完了時に「最大彩度」にするなどの特別な演出はせず、復帰時もその時点の達成度に応じた色のままで復活する（違和感防止）。

### 9.4 その他仕様
*   **編集**: 期限やタイトルは作成後も無制限に変更可能。
*   **個数制限**: 同時進行の目標数に制限なし。
*   **徳ポイント**: 目標達成時は、通常のタスクよりも大きなボーナスポイントを付与（演出付き）。
*   **公開範囲**: 目標自体に公開設定を持つ（タスク同様）。紐づくタスクもそれを継承可能。

### 9.5 UX改善 (New)
*   **並び替え機能**:
    *   **ReorderableListView**: 目標カードをドラッグ＆ドロップで自由に並び替え可能。`GoalModel.order`フィールドで永続化。
    *   **並び替えモード**: ヘッダーの「並替」ボタンでモード切替。
        *   **プルプルアニメーション（Jiggle）**: モード中はカードが不規則に揺れ（iOS風）、ドラッグ可能であることを示唆。
        *   **自動折りたたみ**: モード中はタスクリストを非表示（コンパクト化）にし、ドロップゾーンを確保して操作性を向上。
    *   **ドラッグ操作**: 遅延なし（`ReorderableDragStartListener`）で即座にドラッグ可能。
*   **展開・詳細遷移**:
    *   **タップ操作**: カード本体タップで「タスク一覧の展開/折りたたみ」を切り替え。
    *   **詳細ボタン**: ヘッダー右上のアイコン（📤）で詳細画面へ遷移。
*   **タスク遷移**:
    *   目標カード内のタスクをタップすると、タスク一覧画面の**該当日付へ遷移**し、対象タスクまで**自動スクロール＆ハイライト**する。

---

## 10. TODO: 未完了タスク一覧機能

### 10.1 課題
現在のカレンダーベース表示では以下の問題がある:
*   **期限なしタスク**がカレンダーから見えなくなる
*   日付が進むと**未完了タスク**の把握が困難
*   完了していないタスクを確認するために日付を手動で戻す手間が発生

### 10.2 提案する解決策
**カテゴリタブに「未完了」タブを追加**

```
[タスク] [📋 未完了] [カテゴリA] [＋]
```

*   **表示内容**:
    *   期限切れタスク（赤ラベル）→ 優先度高く上部表示
    *   今日期限のタスク → 次に表示
    *   期限なしタスク → 最後に表示
    *   完了済みタスク → 非表示

*   **メリット**:
    *   既存のカレンダー表示と同じ操作感
    *   タブ切り替えで未完了一覧をすぐ確認可能
    *   実装が比較的シンプル

### 10.3 実装ステータス
- [ ] 未着手

## 11. タスク通知機能 (Server-Side)

### 11.1 概要
タスクに設定したリマインダーと予定時刻にプッシュ通知を送信する機能。

### 11.2 通知の種類
| 通知タイプ | タイトル | 本文例 | タイミング |
|-----------|---------|--------|-----------|
| 事前リマインダー | 🔔 タスクリマインダー | 「タスク名」の30分前です | 設定した事前時間 |
| 予定時刻通知 | 📋 タスクの時間です | 「タスク名」の予定時刻になりました | 予定時刻ちょうど |

### 11.3 技術実装（イベント駆動方式 - 2025-12-26更新）
*   **アーキテクチャ**: ポーリング方式からイベント駆動方式に変更
*   **Cloud Tasks**: `task-reminders` キューでリマインダーをスケジュール
*   **Firestore Triggers**:
    *   `scheduleTaskRemindersOnCreate`: タスク作成時にリマインダーを登録
    *   `scheduleTaskReminders`: タスク更新時に古いリマインダーをキャンセル→新規登録
*   **HTTP Endpoint**: `executeTaskReminder` - Cloud Tasksから呼び出されて通知送信
*   **重複防止**: `sentReminders` コレクションで送信済みを記録
*   **スケジュール管理**: `scheduledReminders` コレクションでCloud Tasks名を記録

### 11.4 更新時のフロー
1. タスクの`scheduledAt`または`reminders`が変更されると`scheduleTaskReminders`が発火
2. 既存の`scheduledReminders`をクエリして、対応するCloud Tasksをキャンセル
3. Firestoreから`scheduledReminders`レコードを削除
4. 新しいリマインダー時刻を計算してCloud Tasksに登録
5. 新しい`scheduledReminders`レコードを作成

### 11.5 コスト最適化（2025-12-26）
| 指標 | 変更前（ポーリング） | 変更後（イベント駆動） |
|------|---------------------|----------------------|
| Cloud Functions呼び出し | 1440回/日（毎分） | タスク作成/更新分のみ |
| Firestoreクエリ | 毎分全タスク検索 | タスク変更時のみ |

### 11.6 実装ステータス
- [x] 事前リマインダー通知 ✅
- [x] 予定時刻通知 ✅
- [x] 重複送信防止 ✅
- [x] イベント駆動方式への移行 ✅ (2025-12-26)

## 12. カテゴリ機能

### 12.1 概要
ユーザーがカスタムカテゴリを作成し、タスクを整理できる機能。

### 12.2 機能一覧
| 機能 | 説明 | 実装状況 |
|------|------|----------|
| **カテゴリ作成** | 「+」タブから新規カテゴリを作成 | ✅ 実装済み |
| **カテゴリ編集** | タブ長押しで名前変更・削除 | ✅ 実装済み |
| **カテゴリフィルタリング** | タブ切り替えでカテゴリごとにタスクを表示 | ✅ 実装済み |
| **デフォルトカテゴリ設定** | カテゴリ選択中にタスク作成→そのカテゴリを初期選択 | ✅ 実装済み (2025-12-18) |
| **タスク編集でカテゴリ変更** | タスク詳細画面でカテゴリを変更可能 | ✅ 実装済み (2025-12-19) |

### 12.3 技術実装
*   **データ管理**: `selectedCategoryIdProvider` で選択中のカテゴリIDを管理
*   **Provider連携**: TasksScreenでタブ変更時にProvider更新、MainShellで読み取り
*   **UI**: TabBar + TabBarView でカテゴリごとにタスクリストを表示
*   **カテゴリ変更**: TaskDetailSheet内にChoiceChipでカテゴリ選択UI
*   **copyWith対応**: `TaskModel.copyWith`に`clearCategoryId`フラグを追加し、nullへの変更に対応

## 13. ストリーク自動投稿機能 ✅ (2025-12-28)

### 13.1 概要
繰り返しタスクの連続完了（ストリーク）を記録し、節目達成時または目標達成時に自動でお祝い投稿を作成する機能。

### 13.2 データ構造

| フィールド | 型 | 説明 |
|---|---|---|
| `TaskModel.streak` | int | 連続達成日数 |
| `TaskModel.completionPostId` | String? | 自動投稿のID（取り消し時の削除用） |

### 13.3 ストリーク計算ロジック
*   **対象**: `recurrenceGroupId` を持つ繰り返しタスクのみ
*   **計算タイミング**: タスク完了時（`TaskService.completeTask`）
*   **計算方法**:
    *   同じグループの直前タスクが完了済み → `前のstreak + 1`
    *   直前タスクが未完了 → `1` にリセット
*   **取り消し時**: `streak = 0` にリセット

### 13.4 マイルストーン判定
| 区分 | 日数 | 称賛ワード例 |
|---|---|---|
| 初期 | 3, 7, 14, 21 | 三日坊主脱出！, 1週間継続！ |
| 定着期 | 30, 60, 90... | 1ヶ月達成、習慣の達人！ |
| 長期 | 100, 200... / 365, 730... | 100日達成、伝説級の記録！ |

### 13.5 自動投稿
*   **トリガー**: マイルストーン達成 or 目標達成（タスク完了でgoalId紐付きの目標が100%達成）
*   **投稿先**: Cloud Functions経由（`AIService.createPostWithRateLimit`）
*   **投稿内容例**:
    *   🔥 「タスク名」を7日連続達成しました！
    *   🎉 目標「目標名」を達成しました！おめでとうございます！
*   **投稿削除**: タスク完了取り消し時、`completionPostId` を使って自動削除

### 13.6 UI演出
| 要素 | 説明 |
|---|---|
| **ConfettiWidget** | マイルストーン達成時に紙吹雪アニメーション |
| **Snackbar** | 称賛ワード付き（例: 🎉 7日連続達成！1週間継続！） |
| **TaskCard** | 🔥アイコン + ストリーク数をリアルタイム表示 |

### 13.7 技術実装
*   **TaskService**: `completeTask`, `uncompleteTask`, `saveCompletionPostId`, `isMilestone`, `getMilestoneMessage`
*   **PostService**: `createTaskCompletionPost`, `deletePostById`
*   **GoalService**: `getGoalProgress` にuserIdパラメーター追加（セキュリティルール対応）
*   **Firestoreインデックス**: `tasks`コレクションに`userId + recurrenceGroupId + scheduledAt DESC`追加

