# 定期クリーンアップ処理設計書

このドキュメントでは、システムで実行されている定期クリーンアップ処理を一覧化し、各処理の目的、実行タイミング、保持期間を記載します。

---

## 概要

| 関数名 | 実行時刻 (JST) | 対象 | 保持期間 |
|--------|--------------|------|---------|
| `cleanupOrphanedMedia` | 毎日 03:00 | 孤立メディアファイル | 24時間 |
| `cleanupResolvedInquiries` | 毎日 03:00 | 解決済み問い合わせ | 7日間 |
| `checkGhostCircles` | 毎日 03:30 | ゴースト/放置サークル | 365日/30日 + 7日猶予 |
| `cleanupBannedUsers` | 毎日 04:00 | 永久BANユーザー | スケジュール日時到達時 |
| `cleanupReports` | 毎日 00:00 | 対処済みレポート | 1ヶ月 |

---

## 1. `cleanupOrphanedMedia` - 孤立メディアクリーンアップ

### 目的
Firebase Storage上に残っている、どのドキュメントからも参照されていない孤立メディアファイルを削除します。

### 実行タイミング
- **スケジュール**: `0 3 * * *` （毎日午前3時 JST）
- **タイムアウト**: 600秒（10分）

### 保持期間
- **24時間**: アップロードから24時間以上経過した孤立メディアが削除対象

### 対象ディレクトリ
| ディレクトリ | 対象 |
|------------|------|
| `posts/` | 投稿メディア |
| `avatars/` | アバター画像 |
| `circles/` | サークル画像 |
| `inquiries/` | 問い合わせ添付画像 |

### 処理フロー
1. 各ディレクトリのファイル一覧を取得
2. ファイルがどのドキュメントからも参照されていないか確認
3. アップロードから24時間以上経過していれば削除

---

## 2. `cleanupResolvedInquiries` - 解決済み問い合わせクリーンアップ

### 目的
解決済み（resolved）の問い合わせを一定期間後に自動削除し、アーカイブに保存します。

### 実行タイミング
- **スケジュール**: `0 3 * * *` （毎日午前3時 JST）

### 保持期間
| 経過日数 | アクション |
|---------|-----------|
| 6日以上 | ユーザーに削除予告通知を送信 |
| 7日以上 | 問い合わせを削除、アーカイブに保存 |

### 処理フロー
1. `status == "resolved"` の問い合わせを取得
2. `resolvedAt` から経過日数を計算
3. 7日以上経過: `deleteInquiryWithArchive()` で削除＆アーカイブ
   - `archivedInquiries` コレクションに保存
   - 添付画像をStorageから削除
   - メッセージサブコレクションを削除
4. 6日以上7日未満: ユーザーに削除予告通知を送信

### アーカイブ保存内容
- 問い合わせID、ユーザー情報、件名、カテゴリ
- 全メッセージ（content, senderType, createdAt）
- 作成日時、解決日時、削除日時

---

## 3. `checkGhostCircles` - ゴースト/放置サークル検出

### 目的
活動のないサークルを検出し、オーナーに警告後、自動削除します。

### 実行タイミング
- **スケジュール**: `30 3 * * *` （毎日午前3時30分 JST）
- **タイムアウト**: 540秒（9分）
- **メモリ**: 512MiB

### 保持期間・判定基準

| サークル種別 | 条件 | 削除までの期間 |
|------------|------|--------------|
| **ゴーストサークル** | 最後の人間投稿から365日以上経過 | 警告通知 + 7日猶予 |
| **放置サークル** | 人間投稿なし かつ 作成から30日以上経過 | 警告通知 + 7日猶予 |

### 処理フロー
1. 削除されていないサークルを全件取得
2. 各サークルについて：
   - `lastHumanPostAt < 365日前` → ゴーストサークル
   - `lastHumanPostAt == null && createdAt < 30日前` → 放置サークル
3. 未通知の場合：オーナーに警告通知を送信、`ghostWarningNotifiedAt` を記録
4. 通知から7日以上経過：サークルを自動削除

### 関連定数
```typescript
const GHOST_THRESHOLD_DAYS = 365; // ゴースト判定日数
const EMPTY_THRESHOLD_DAYS = 30;  // 放置判定日数
const DELETE_GRACE_DAYS = 7;      // 猶予期間
```

---

## 4. `cleanupBannedUsers` - 永久BANユーザー削除

### 目的
永久BANされたユーザーのアカウントを、スケジュールされた日時に完全削除します。

### 実行タイミング
- **スケジュール**: `0 4 * * *` （毎日午前4時 JST）
- **タイムアウト**: 540秒（9分）

### 保持期間
- **可変**: `permanentBanScheduledDeletionAt` フィールドに設定された日時
- 通常、永久BAN時点から一定期間（例: 30日）後に設定される

### 対象クエリ条件
```typescript
db.collection("users")
  .where("banStatus", "==", "permanent")
  .where("permanentBanScheduledDeletionAt", "<=", now)
  .limit(20)
```

### 処理フロー
1. 削除スケジュール日時が到達した永久BANユーザーを取得（最大20件）
2. 各ユーザーについて：
   - Firebase Authenticationからユーザーを削除
   - Firestoreの `users` ドキュメントを削除

### 必要なインデックス
- コレクション: `users`
- フィールド: `banStatus` (Ascending), `permanentBanScheduledDeletionAt` (Ascending)

---

## 5. `cleanupReports` - レポートクリーンアップ

### 目的
対処済みの通報（レポート）を一定期間後に自動削除します。

### 実行タイミング
- **スケジュール**: `every day 00:00` （毎日午前0時 JST）
- **タイムアウト**: 300秒（5分）

### 保持期間
- **1ヶ月**: 対処済み（reviewed/dismissed）かつ作成から1ヶ月以上経過

### 対象ステータス
| ステータス | 説明 |
|-----------|------|
| `reviewed` | 対処済み |
| `dismissed` | 却下済み |

### 処理フロー
1. `status == "reviewed" && createdAt < 1ヶ月前` のレポートを取得
2. `status == "dismissed" && createdAt < 1ヶ月前` のレポートを取得
3. 取得したレポートを全て削除

---

## 実行スケジュール一覧（時系列）

| 時刻 (JST) | 関数名 | 概要 |
|-----------|--------|------|
| 00:00 | `cleanupReports` | 対処済みレポート削除 |
| 03:00 | `cleanupOrphanedMedia` | 孤立メディア削除 |
| 03:00 | `cleanupResolvedInquiries` | 解決済み問い合わせ削除 |
| 03:30 | `checkGhostCircles` | ゴースト/放置サークル検出・削除 |
| 04:00 | `cleanupBannedUsers` | 永久BANユーザー削除 |

---

## 保持期間まとめ

| 対象 | 保持期間 | 備考 |
|------|---------|------|
| 孤立メディア | 24時間 | アップロード後、参照なし |
| 解決済み問い合わせ | 7日間 | 解決後から起算 |
| ゴーストサークル | 365日 + 7日猶予 | 最後の人間投稿から起算 |
| 放置サークル | 30日 + 7日猶予 | サークル作成から起算 |
| 永久BANユーザー | スケジュール日時 | BAN時に設定された日時 |
| 対処済みレポート | 1ヶ月 | レポート作成から起算 |

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-01-10 | 初版作成 |
