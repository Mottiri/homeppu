# 機能修正・追加バックログ (2025-12-18)

このドキュメントは、ほめっぷアプリの細かい修正と追加機能の提案をまとめたものです。

---

## 📋 タスク機能

### 1. カテゴリフィルタリング ✅
- **優先度**: 高
- **状態**: ✅ 実装済み（確認完了 2025-12-18）
- **内容**: 
  - タスク一覧にカテゴリフィルターを追加
  - カテゴリをタップすると、そのカテゴリに紐づくタスクのみ表示
  - 例: ゲームカテゴリ選択 → ゲームに紐づくタスク2件のみ表示
- **実装箇所**: `tasks_screen.dart`
  - TabBarでカテゴリタブを動的生成
  - TabBarViewでカテゴリごとにタスクリストを表示
  - 「+」タブで新規カテゴリ追加可能

### 2. 月間カレンダーの完了タスク優先非表示 ✅
- **優先度**: 中
- **状態**: ✅ 実装済み（2025-12-18）
- **内容**:
  - 複数タスクがある日で「+9」などで省略される場合
  - 完了済みタスクを優先的に省略（非表示）にする
  - 未完了タスクを優先的に表示
- **実装箇所**: `monthly_calendar_screen.dart`
  - タスクリストを未完了優先でソート
  - 同じ完了状態なら優先度で降順ソート

### 3. タスク表示設定機能
- **優先度**: 中
- **状態**: 未着手
- **内容**:
  - タスク画面のヘッダーに設定アイコン（⚙️）を配置
  - タップでボトムシート表示
  - 表示/非表示の切替項目:
    - メモを表示 [ON/OFF]
    - 繰り返しアイコン [ON/OFF]
    - 添付画像サムネイル [ON/OFF]
    - リマインダーアイコン [ON/OFF]
    - サブタスク表示 [ON/OFF]
  - 設定は端末に保存（SharedPreferences）

### 3. カスタム画像設定（アイコン・ヘッダー） ✅
- **優先度**: 中
- **状態**: ✅ 完全実装済み
- **内容**:
  - サークル作成時・編集時にオーナーがアイコン・ヘッダー画像を設定可能
  - `image_cropper`でアスペクト比固定（アイコン1:1、ヘッダー16:9）
  - 削除ボタン（×）でデフォルトに戻る
  - Firebase Storageに`circles/{circleId}/icon/`または`cover/`で保存
  - ✅ AIモデレーション（保存時に不適切画像をブロック）
  - ✅ Storage画像削除（サークル削除時）← `cleanupDeletedCircle`で実装済み

### 4. 「プログラミング」カテゴリの削除 ✅
- **優先度**: 低
- **状態**: ✅ 実装済み（2025-12-19）
- **内容**:
  - サークルカテゴリから「プログラミング」を削除
  - ターゲット層に合わせたカテゴリ整理

### 5. タスク編集画面でカテゴリ変更可能に ✅
- **優先度**: 中
- **状態**: ✅ 実装済み（2025-12-19）
- **内容**:
  - 現在タスク作成後はカテゴリを変更できない
  - タスク編集画面でカテゴリも変更可能にする

---

## ❤️ リアクション機能

### 5. リアクションアイコンのカテゴリ分け ✅
- **優先度**: 高
- **状態**: ✅ 実装済み（2025-12-18）
- **内容**:
  - リアクションボタン押下時、アイコンをカテゴリ別に整理
  - 画面いっぱいに表示されず、コンパクトなタブ形式で表示
- **実装箇所**: 
  - `app_constants.dart` - `ReactionCategory` enum（5カテゴリ）
  - `reaction_selection_sheet.dart` - タブ形式でカテゴリ切り替え
  - `recent_reactions_service.dart` - 直近使用リアクション管理
- **カテゴリ**:
  - ⏱️ **よく使う**（直近使用した最大7件、履歴がある場合のみ表示）
  - ❤️ おすすめ（❤️✨💪🤝🎈☺️🍌）
  - ⭐ 記号（⭐💗💙🔥👍👏など）
  - 😊 表情（😊😆😂😍🥳など）
  - 🌸 自然・生き物（🐱🐶🌸🌈など）
  - 🎁 食べ物・アイテム（🎁🏆☕🍰🍣など）

### 6. リアクション時のアニメーション強化 ✅
- **優先度**: 中
- **状態**: ✅ 完全実装済み（2025-12-21）
- **内容**:
  - リアクション押下時のアニメーション演出
  - **仕様**: リアクション直後は大きいサイズのアイコン → だんだん小さくなる → 背景に溶け込んで最終サイズになる（300ms）
  - ~~AI・ユーザー問わず全員に見えるアニメーション~~ → リアクションを付けた人のみ表示
- **シート連続操作**: シートを閉じずに複数回リアクション可能。5回でシート自動クローズ+トースト表示。
- **実装箇所**: 
  - `reaction_background.dart` - StatefulWidget、新規リアクション検知時にスケールアニメーション
  - `reaction_selection_sheet.dart` - 連続操作対応、5回カウント
  - `post_card.dart` - ローカルリアクション状態管理、5回制限チェック

> [!NOTE]
> **決定**: 全員に見えるアニメーションはちらつき問題があるため、リアクション追加者のみに変更（2025-12-19）
> **更新**: 背景スタンプアニメーション復元、シート連続操作対応（2025-12-21）

### 7. リアクション回数制限 ✅
- **優先度**: 高
- **状態**: ✅ 完全実装済み（2025-12-21）
- **内容**:
  - 1人あたり1投稿に対して最大5回まで
  - スパム防止
- **実装箇所**: 
  - `functions/src/index.ts` - `addUserReaction`関数（バックエンド制限・セキュリティ）
  - `post_card.dart` - シート表示前にFirestoreから既存リアクション数を確認、5回でトースト表示してシートを開かない
  - `reaction_selection_sheet.dart` - シート内で5回リアクション後、シート自動クローズ+トースト表示

### 8. AIリアクション数の調整 ✅
- **優先度**: 中
- **状態**: ✅ 実装済み（2025-12-18）、✅ 重複防止追加（2025-12-19）
- **内容**:
  - AIは1投稿に1回のみリアクション
  - **5〜15件（平均10件）**に調整
  - 理由: 30件は通知が多すぎる、MIXモードへの誘導のため
- **実装箇所**: `functions/src/index.ts` - `onPostCreated`関数
- **重複防止**: `generateAIReactionV1`で既存リアクションをチェックし、同じAIが2回以上リアクションしないよう修正

> [!NOTE]
> **変更履歴**: 15〜30件 → 5〜15件（2025-12-18）
> **バグ修正**: 同じAIが複数回リアクションする問題を修正（2025-12-19）

### 9. 長押しリアクションUI ✅
- **優先度**: 高
- **状態**: ✅ 実装済み（2025-12-25）
- **内容**:
  - 投稿カード長押しでLINE風オーバーレイ表示
  - スタガードアニメーション（スタンプが1つずつぽぽんと出現）
  - カスタムアセット対応（7種類: heart, praise, shine, clap, star, hundred, rainbow）
  - 背景タップで閉じる、5回で自動閉じ
- **実装箇所**: `post_card.dart`

### 10. カスタムスタンプ機能（将来）
- **優先度**: 中
- **状態**: 未実装
- **対象**: サブスク課金者限定
- **内容**:
  - ユーザーが独自スタンプ画像を登録
  - 作成者本人のみ使用可能
  - ファイルサイズ制限あり
- **審査フロー**:
  1. システム審査（AI画像審査で違反拒否）
  2. 管理者目視審査（許可/拒否）
  3. 通知（許可: 使用可能、拒否: 理由付き）
- **設計書**: `docs/design/reaction_system_design.md` セクション7

### 11. 新着投稿ドット表示（廃止）
- **優先度**: -
- **状態**: ❌ 廃止（2025-12-25）
- **理由**: AIモードフィルタリングとFirestoreスナップショット監視の不整合により誤検知が頻発
- **代替案**: ユーザーがプルダウンで手動更新

### 12. 拡張可能スタンプバー ✅
- **優先度**: 高
- **状態**: ✅ 実装済み（2025-12-25）
- **内容**:
  - 5つのスタンプ + ＋アイコン（右端）
  - ＋押下で残りスタンプを縦長リストで表示
  - 横スクロール対応（オーバーフロー防止）
  - 拡張リストにもポップアニメーション
- **実装箇所**: `post_card.dart` - `_ReactionOverlayDialog`

### 13. スタンプ昇格機能 ✅
- **優先度**: 中
- **状態**: ✅ 実装済み（2025-12-25）
- **内容**:
  - 使用したスタンプが次回表示時にバーの先頭に移動
  - 最も使用していないスタンプが＋アイコン内に格納
  - `RecentReactionsService`で使用順を永続化
- **実装箇所**: `post_card.dart`, `recent_reactions_service.dart`

---

## 👤 プロフィール画面

### 9. 賞賛カウントの修正（バグ）✅
- **優先度**: 高
- **状態**: ✅ 完了（2025-12-18）
- **内容**:
  - 「賞賛」の項目がカウントされていない問題を修正
- **実装内容**:
  - `onReactionCreated` トリガーを Cloud Functions に追加
  - リアクション追加時に投稿者の `totalPraises` を自動インクリメント
  - 自己リアクションはカウントしない

### 10. 投稿カードのスマート化
- **優先度**: 中
- **状態**: 未着手
- **内容**:
  - 過去の投稿カードをコンパクトに表示
  - 画像添付、コメント数、リアクション有無はアイコンで表現
  - タップで詳細画面へ遷移

### 11. お気に入り投稿機能
- **優先度**: 中
- **状態**: 未着手
- **内容**:
  - 過去の投稿をお気に入り登録
  - お気に入り投稿は上部に表示
  - 過去の賞賛をいつでも見返せる

> [!NOTE]
> **決定**: 名称は「お気に入り」で進行（2025-12-18）

### 12. 過去投稿のサークル投稿区別
- **優先度**: 中
- **状態**: 未着手
- **内容**:
  - 現在はサークル投稿と一般投稿が混在して表示されている
  - サークル投稿を視覚的に区別したい
  - **検討中の方法**:
    - 過去の投稿カードにサークルアイコンを追加
    - タブで「すべて」「一般」「サークル」に分ける
    - サークル名ラベルを表示

---

## ✏️ 投稿画面

### 12. 添付アイコンの変更
- **優先度**: 低
- **状態**: 未着手
- **内容**:
  - クリップアイコン → 「+」アイコンに変更

### 13. 投稿詳細画面でメディアを表示 ✅
- **優先度**: 高
- **状態**: ✅ 実装済み（2025-12-19）
- **内容**:
  - 投稿一覧のカードにはメディア（画像・動画）が表示されている
  - ~~**問題**: 投稿詳細画面ではメディアが見えない~~
  - ✅ 詳細画面でもメディアを閲覧可能にする
  - プロフィール画面の過去の投稿カードに、添付メディアがある場合アイコンとして表示して、一目でわかるようにする
- **実装箇所**: `post_detail_screen.dart`
  - `_buildMediaSection`メソッドでメディア表示
  - 画像タップでフルスクリーン表示（InteractiveViewer）

### 14. 動画サムネイル表示
- **優先度**: 中
- **状態**: 未着手
- **内容**:
  - 動画添付時、最初の1フレームをサムネイルとして表示
  - 現状は動画アイコンのみ表示？
  - プレビュー画像があると内容がわかりやすい

---

## 🔔 通知画面

### 13. 通知のカテゴリ分け
- **優先度**: 中
- **状態**: ✅ 実装済み（2025-12-21）
- **内容**:
  - タブで4カテゴリに分類:
    - **すべて**: 全通知
    - **TL**: コメント、リアクション
    - **サークル**: 参加申請、承認、拒否、削除
    - **タスク**: リマインダー、予定時刻通知
  - 各タブに未読バッジ表示（赤丸で件数表示）
  - スクロール対応（狭い画面でも横スクロール可能）

---

## 🛡️ 管理者機能

### 14. 管理者専用機能
- **優先度**: 低（運用フェーズでは必須）その他機能を作り終えたら高
- **状態**: 未実装
- **内容**:
  - BAN権限
  - 通報一覧確認
  - 問い合わせ一覧確認と返信
  - 管理者アカウントのみに表示
---

## 🤖 AI/Gemini API

### 15. Gemini APIエラー対策
- **優先度**: 高
- **状態**: ✅ 実装完了
- **内容**:
  - **OpenAI/Geminiフォールバック機能**:
    - `AIProviderFactory`クラスで両プロバイダーをサポート
    - Firestore設定（`settings/ai`）でプライマリプロバイダー切り替え可能
    - プライマリ失敗時に自動でフォールバック
  - **実装ファイル**: `functions/src/ai/provider.ts`
- **完了日**: 2025-12-26

---

## 🎨 UI全般

### 15. UI調整
- **優先度**: 低（機能実装後）
- **状態**: 未着手
- **内容**:
  - 全体的なUIのブラッシュアップ
  - 機能改修・追加完了後に着手

---

## 💰 マネタイズ

### 16. 広告表示
- **優先度**: 中
- **状態**: 未実装
- **内容**:
  - 基本は広告表示

### 17. サブスクリプション課金
- **優先度**: 中
- **状態**: 未実装
- **内容（要議論）**:

### 課金モデル（決定版）
| 無料 | サブスク（プレミアム） |
|------|----------------------|
| 全タスク機能 | 広告OFF |
| 基本名前パーツ | レア名前パーツ解放 |
| 基本アバター | 限定アバターパーツ |
| サークル参加 | サークル作成数増加 |
| - | **投稿装飾機能** |
| - | [プレミアム][課金者] バッジ |

### 投稿装飾機能（技術確認済み）
- **技術的に実装可能** ✅
- **実装方法**: `Stack` + `Positioned` widgetでカード角に装飾配置
- **装飾例**:
  - 王冠（プレミアムバッジ）
  - キラキラ（パーティクルエフェクト）
  - 豪華フレーム
  - 背景パターン

---

## 📛 名前パーツ

### 18. アイコン位置の調整
- **優先度**: -（対応不要）
- **状態**: 現状維持に決定
- **内容**:
  - 現在のアイコン位置（真ん中）を維持

> [!NOTE]
> **議論点**: アイコンがあることで視覚的な識別性が上がり、他SNSとの差別化になる。
> 現状維持を推奨。

---

## 🔧 リファクタリング

### 19. サークルカテゴリ定義の統一 ✅
- **優先度**: -（対応完了）
- **状態**: ✅ 完了（2025-12-19）
- **内容**:
  - `circle_service.dart`, `circles_screen.dart`, `circle_detail_screen.dart` の3箇所に重複していたカテゴリ定義を `CircleService` に一本化
  - 変更時の修正箇所を1箇所に集約し、不整合（バグ）を防止
- **重複の原因**:
  - 初期開発段階で、一覧画面と詳細画面の実装が独立して進められた際、それぞれでカテゴリ用のMapを定義してしまい、共通のServiceを参照する設計になっていなかったため。


### 20. サークル一覧のUX改善（無限スクロール・Pull to Refresh） ✅
- **優先度**: 高
- **状態**: ✅ 実装済み（2025-12-24）
- **内容**:
  - **Pull to Refresh**: 一覧を下に引っ張って更新する機能を追加
  - **無限スクロール**: スクロール最下部で自動的に次の件数を読み込む機能を追加
  - **タブ切替時の自動更新**: カテゴリタブを切り替えた際にリストをリフレッシュ
- **実装箇所**:
  - `circle_service.dart`: `getPublicCircles`にページネーション対応（`lastDocument`, `limit`）
  - `circles_screen.dart`: `RefreshIndicator`, `ScrollController`による制御

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-12-18 | 初版作成 |
