# 機能修正・追加バックログ (2025-12-18)

このドキュメントは、ほめっぷアプリの細かい修正と追加機能の提案をまとめたものです。

---

## 🔔 通知機能（2026-01-12 追加）

### 17. プッシュ通知タップ遷移の総点検・修正
- **優先度**: 中
- **状態**: ⬜ 未着手
- **問題**: 
  - 目標の事前通知など、タップしても詳細画面ではなく通知一覧画面に遷移してしまう
  - `main.dart` の `_handleNotificationTap` で特定の `type` を処理していないため、`default` ルートに落ちている
- **内容**:
  - 全通知タイプの洗い出し（`goal_reminder`, `streak_milestone` など）
  - 各タイプの通知ペイロードに適切な `taskId`, `goalId` 等が含まれているか確認
  - `main.dart` のスイッチ文に遷移ロジックを追加
    - 目標通知 → 目標詳細画面
    - 問い合わせ詳細 → 問い合わせチャット画面（実装済みだが再確認）
    - その他通知 → 適切なコンテンツへ
- **期待値**: 全てのプッシュ通知から、関連する詳細画面へ直接遷移できること

---

## 📋 タスク機能

### 1. カテゴリフィルタリング ✅
- **優先度**: 高
- **状態**: ✅ 実装済み（確認完了 2025-12-18）
- **内容**: 
  - タスク一覧にカテゴリフィルターを追加
  - カテゴリをタップすると、そのカテゴリに紐づくタスクのみ表示
  - 例: ゲームカテゴリ選択 → ゲームに紐づくタスク2件のみ表示
- **実装箇所**: `tasks_screen.dart`
  - TabBarでカテゴリタブを動的生成
  - TabBarViewでカテゴリごとにタスクリストを表示
  - 「+」タブで新規カテゴリ追加可能

### 2. 月間カレンダーの完了タスク優先非表示 ✅
- **優先度**: 中
- **状態**: ✅ 実装済み（2025-12-18）
- **内容**:
  - 複数タスクがある日で「+9」などで省略される場合
  - 完了済みタスクを優先的に省略（非表示）にする
  - 未完了タスクを優先的に表示
- **実装箇所**: `monthly_calendar_screen.dart`
  - タスクリストを未完了優先でソート
  - 同じ完了状態なら優先度で降順ソート

### 3. タスク表示設定機能
- **優先度**: 中
- **状態**: ⏸️ 保留
- **内容**:
  - タスク画面のヘッダーに設定アイコン（⚙️）を配置
  - タップでボトムシート表示
  - 表示/非表示の切替項目:
    - メモを表示 [ON/OFF]
    - 繰り返しアイコン [ON/OFF]
    - 添付画像サムネイル [ON/OFF]
    - リマインダーアイコン [ON/OFF]
    - サブタスク表示 [ON/OFF]
  - 設定は端末に保存（SharedPreferences）

### 3. カスタム画像設定（アイコン・ヘッダー） ✅
- **優先度**: 中
- **状態**: ✅ 完全実装済み
- **内容**:
  - サークル作成時・編集時にオーナーがアイコン・ヘッダー画像を設定可能
  - `image_cropper`でアスペクト比固定（アイコン1:1、ヘッダー16:9）
  - 削除ボタン（×）でデフォルトに戻る
  - Firebase Storageに`circles/{circleId}/icon/`または`cover/`で保存
  - ✅ AIモデレーション（保存時に不適切画像をブロック）
  - ✅ Storage画像削除（サークル削除時）← `cleanupDeletedCircle`で実装済み

### 4. 「プログラミング」カテゴリの削除 ✅
- **優先度**: 低
- **状態**: ✅ 実装済み（2025-12-19）
- **内容**:
  - サークルカテゴリから「プログラミング」を削除
  - ターゲット層に合わせたカテゴリ整理

### 5. タスク編集画面でカテゴリ変更可能に ✅
- **優先度**: 中
- **状態**: ✅ 実装済み（2025-12-19）
- **内容**:
  - 現在タスク作成後はカテゴリを変更できない
  - タスク編集画面でカテゴリも変更可能にする

### 6. ストリーク自動投稿機能 ✅
- **優先度**: 高
- **状態**: ✅ 実装済み（2025-12-28）
- **内容**:
  - 繰り返しタスクの連続達成（ストリーク）を記録
  - 節目達成時（3日, 7日, 14日, 21日, 30日ごと, 100日ごと, 365日ごと）に自動投稿
  - 目標達成時にも自動投稿
  - 紙吹雪アニメーション + 称賛Snackbar
  - タスクカードに🔥アイコン + 数字でストリーク表示
  - 完了取り消し時、自動投稿を自動削除
- **設計書**: `task_feature_design.md` セクション13, `goal_feature_design.md` セクション6

---

## ❤️ リアクション機能

### 5. リアクションアイコンのカテゴリ分け ✅
- **優先度**: 高
- **状態**: ✅ 実装済み（2025-12-18）
- **内容**:
  - リアクションボタン押下時、アイコンをカテゴリ別に整理
  - 画面いっぱいに表示されず、コンパクトなタブ形式で表示
- **実装箇所**: 
  - `app_constants.dart` - `ReactionCategory` enum（5カテゴリ）
  - `reaction_selection_sheet.dart` - タブ形式でカテゴリ切り替え
  - `recent_reactions_service.dart` - 直近使用リアクション管理
- **カテゴリ**:
  - ⏱️ **よく使う**（直近使用した最大7件、履歴がある場合のみ表示）
  - ❤️ おすすめ（❤️✨💪🤝🎈☺️🍌）
  - ⭐ 記号（⭐💗💙🔥👍👏など）
  - 😊 表情（😊😆😂😍🥳など）
  - 🌸 自然・生き物（🐱🐶🌸🌈など）
  - 🎁 食べ物・アイテム（🎁🏆☕🍰🍣など）

### 6. リアクション時のアニメーション強化 ✅
- **優先度**: 中
- **状態**: ✅ 完全実装済み（2025-12-21）
- **内容**:
  - リアクション押下時のアニメーション演出
  - **仕様**: リアクション直後は大きいサイズのアイコン → だんだん小さくなる → 背景に溶け込んで最終サイズになる（300ms）
  - ~~AI・ユーザー問わず全員に見えるアニメーション~~ → リアクションを付けた人のみ表示
- **シート連続操作**: シートを閉じずに複数回リアクション可能。5回でシート自動クローズ+トースト表示。
- **実装箇所**: 
  - `reaction_background.dart` - StatefulWidget、新規リアクション検知時にスケールアニメーション
  - `reaction_selection_sheet.dart` - 連続操作対応、5回カウント
  - `post_card.dart` - ローカルリアクション状態管理、5回制限チェック

> [!NOTE]
> **決定**: 全員に見えるアニメーションはちらつき問題があるため、リアクション追加者のみに変更（2025-12-19）
> **更新**: 背景スタンプアニメーション復元、シート連続操作対応（2025-12-21）

### 7. リアクション回数制限 ✅
- **優先度**: 高
- **状態**: ✅ 完全実装済み（2025-12-21）
- **内容**:
  - 1人あたり1投稿に対して最大5回まで
  - スパム防止
- **実装箇所**: 
  - `functions/src/index.ts` - `addUserReaction`関数（バックエンド制限・セキュリティ）
  - `post_card.dart` - シート表示前にFirestoreから既存リアクション数を確認、5回でトースト表示してシートを開かない
  - `reaction_selection_sheet.dart` - シート内で5回リアクション後、シート自動クローズ+トースト表示

### 8. AIリアクション数の調整 ✅
- **優先度**: 中
- **状態**: ✅ 実装済み（2025-12-18）、✅ 重複防止追加（2025-12-19）
- **内容**:
  - AIは1投稿に1回のみリアクション
  - **5〜15件（平均10件）**に調整
  - 理由: 30件は通知が多すぎる、MIXモードへの誘導のため
- **実装箇所**: `functions/src/index.ts` - `onPostCreated`関数
- **重複防止**: `generateAIReactionV1`で既存リアクションをチェックし、同じAIが2回以上リアクションしないよう修正

> [!NOTE]
> **変更履歴**: 15〜30件 → 5〜15件（2025-12-18）
> **バグ修正**: 同じAIが複数回リアクションする問題を修正（2025-12-19）

### 8-1. リアクション背景スタンプの表示範囲修正
- **優先度**: 中
- **状態**: ⬜ 未着手
- **問題**:
  - リアクション時に投稿カード背景にスタンプがたまっていくが、たまにカード外（見えない部分）にスタンプが押されている
  - ユーザーが押したスタンプがカード内に収まらないケースがある
- **修正内容**:
  - スタンプの配置位置をカード内に確実に収めるよう座標計算を修正
  - カード境界からのマージンを設けてオーバーフローを防止
- **将来拡張（レアスタンプ）**:
  - サブスク課金者向けにレアスタンプ機能を追加予定
  - レアスタンプの場合、背景スタンプのサイズを大きく表示
  - 限定アニメーション（キラキラエフェクト等）を追加
- **実装箇所**: `reaction_background.dart`, `post_card.dart`
- **追加日**: 2026-01-14


### 9. 長押しリアクションUI ✅
- **優先度**: 高
- **状態**: ✅ 実装済み（2025-12-25）
- **内容**:
  - 投稿カード長押しでLINE風オーバーレイ表示
  - スタガードアニメーション（スタンプが1つずつぽぽんと出現）
  - カスタムアセット対応（7種類: heart, praise, shine, clap, star, hundred, rainbow）
  - 背景タップで閉じる、5回で自動閉じ
- **実装箇所**: `post_card.dart`

### 10. カスタムスタンプ機能（将来）
- **優先度**: 中
- **状態**: 未実装
- **対象**: サブスク課金者限定
- **内容**:
  - ユーザーが独自スタンプ画像を登録
  - 作成者本人のみ使用可能
  - ファイルサイズ制限あり
- **審査フロー**:
  1. システム審査（AI画像審査で違反拒否）
  2. 管理者目視審査（許可/拒否）
  3. 通知（許可: 使用可能、拒否: 理由付き）
- **設計書**: `docs/design/reaction_system_design.md` セクション7

### 11. 新着投稿ドット表示（廃止）
- **優先度**: -
- **状態**: ❌ 廃止（2025-12-25）
- **理由**: AIモードフィルタリングとFirestoreスナップショット監視の不整合により誤検知が頻発
- **代替案**: ユーザーがプルダウンで手動更新

### 12. 拡張可能スタンプバー ✅
- **優先度**: 高
- **状態**: ✅ 実装済み（2025-12-25）
- **内容**:
  - 5つのスタンプ + ＋アイコン（右端）
  - ＋押下で残りスタンプを縦長リストで表示
  - 横スクロール対応（オーバーフロー防止）
  - 拡張リストにもポップアニメーション
- **実装箇所**: `post_card.dart` - `_ReactionOverlayDialog`

### 13. スタンプ昇格機能 ✅
- **優先度**: 中
- **状態**: ✅ 実装済み（2025-12-25）
- **内容**:
  - 使用したスタンプが次回表示時にバーの先頭に移動
  - 最も使用していないスタンプが＋アイコン内に格納
  - `RecentReactionsService`で使用順を永続化
- **実装箇所**: `post_card.dart`, `recent_reactions_service.dart`

---

## 👤 プロフィール画面

### 9. 賞賛カウントの修正（バグ）✅
- **優先度**: 高
- **状態**: ✅ 完了（2025-12-18）
- **内容**:
  - 「賞賛」の項目がカウントされていない問題を修正
- **実装内容**:
  - `onReactionCreated` トリガーを Cloud Functions に追加
  - リアクション追加時に投稿者の `totalPraises` を自動インクリメント
  - 自己リアクションはカウントしない

### 10. 投稿カードのスマート化
- **優先度**: 中
- **状態**: ✅ 実装完了
- **内容**:
  - プロフィール画面の過去投稿にメディアアイコン（📷/🎥）を追加
  - リアクション背景スタンプを表示（実際に付いたリアクションを可視化）
  - タップで投稿詳細画面へ遷移
- **実装ファイル**: 
  - `profile_screen.dart`: _ProfilePostCardにメディアアイコンとReactionBackground追加
- **完了日**: 2025-12-27

### 11. お気に入り投稿機能
- **優先度**: 中
- **状態**: ✅ 実装完了
- **内容**:
  - プロフィール画面の過去投稿をお気に入り登録
  - 3タブ構成（アイコン表示: 🏠TL / 👥サークル / ⭐お気に入り）
  - 三点メニューから「お気に入りに追加/解除」
  - お気に入りは投稿日時順で表示
- **実装ファイル**: 
  - `post_model.dart`: isFavoriteフィールド追加
  - `profile_screen.dart`: 3タブ・アイコン表示・お気に入りリスト・切替機能
- **完了日**: 2025-12-27

> [!NOTE]
> **決定**: 名称は「お気に入り」で進行（2025-12-18）

### 12. 過去投稿のサークル投稿区別 ✅
- **優先度**: 中
- **状態**: ✅ 実装済み（2025-12-27）
- **内容**:
  - プロフィール画面の過去投稿を3タブで区別
  - 🏠 TL：一般投稿（circleId == null）
  - 👥 サークル：サークル投稿（circleId != null）
  - ⭐ お気に入り：お気に入り登録した投稿
- **実装箇所**: `profile_screen.dart` - `_UserPostsList`クラス

---

## ✏️ 投稿画面

### 12. 添付アイコンの変更
- **優先度**: 低
- **状態**: ⏸️ 保留
- **内容**:
  - クリップアイコン → 「+」アイコンに変更

### 13. 投稿詳細画面でメディアを表示 ✅
- **優先度**: 高
- **状態**: ✅ 実装済み（2025-12-19）
- **内容**:
  - 投稿一覧のカードにはメディア（画像・動画）が表示されている
  - ~~**問題**: 投稿詳細画面ではメディアが見えない~~
  - ✅ 詳細画面でもメディアを閲覧可能にする
  - プロフィール画面の過去の投稿カードに、添付メディアがある場合アイコンとして表示して、一目でわかるようにする
- **実装箇所**: `post_detail_screen.dart`
  - `_buildMediaSection`メソッドでメディア表示
  - 画像タップでフルスクリーン表示（InteractiveViewer）

### 14. 動画サムネイル表示
- **優先度**: 中
- **状態**: ✅ 実装完了
- **内容**:
  - 動画アップロード時に最初のフレームをサムネイルとして自動生成
  - サムネイルをFirebase Storageにアップロード
  - 投稿一覧でサムネイル画像を表示
- **技術詳細**:
  - サムネイルサイズ: 最大高さ800px、JPEG品質90%
  - Firebase Storage: `posts/{userId}/thumbnails/`パスに保存
- **実装ファイル**: 
  - `post_model.dart`: MediaItemにthumbnailUrlフィールド追加
  - `media_service.dart`: _generateAndUploadThumbnailメソッド追加
  - `post_card.dart`: サムネイル表示ロジック更新
  - `firebase/storage.rules`: thumbnailsパスへの権限追加
- **完了日**: 2025-12-27

---

## 🔔 通知画面

### 13. 通知のカテゴリ分け
- **優先度**: 中
- **状態**: ✅ 実装済み（2025-12-21）
- **内容**:
  - タブで4カテゴリに分類:
    - **すべて**: 全通知
    - **TL**: コメント、リアクション
    - **サークル**: 参加申請、承認、拒否、削除
    - **タスク**: リマインダー、予定時刻通知
  - 各タブに未読バッジ表示（赤丸で件数表示）
  - スクロール対応（狭い画面でも横スクロール可能）

---

## 🛡️ 管理者機能

### 14. 管理者専用機能
- **優先度**: 低（運用フェーズでは必須）その他機能を作り終えたら高
- **状態**: ✅ 実装済み（2025-01-05確認）
- **内容**:
  - ✅ BAN権限（`banUser` 実装済み）
  - 通報一覧確認（未実装・保留）
  - ✅ 要審査投稿レビュー（実装済み）
  - ✅ **問い合わせ機能（実装済み 2025-12-29）**
  - 管理者アカウントのみに表示

### 15. 問い合わせ・要望機能 ✅
- **優先度**: 高
- **状態**: ✅ 実装済み（2025-12-29）
- **設計書**: `docs/design/admin_features.md` セクション5
- **内容**:
  - ユーザーからの問い合わせ・機能要望を受け付け
  - カテゴリ: バグ報告 / 機能要望 / アカウント関連 / その他
  - チケット形式（複数往復チャット可）
  - 管理者が返信・ステータス変更可能
  - 画像添付可能
- **通知連携** ✅:
  - 新規問い合わせ → 管理者にプッシュ通知
  - ユーザー返信 → 管理者にプッシュ通知
  - 運営返信 → ユーザーにプッシュ通知
  - ステータス変更 → ユーザーにプッシュ通知
  - 通知画面に「サポート」タブ追加

### 15-1. 問い合わせチャットUX改善 ✅
- **優先度**: 中
- **状態**: ✅ 実装済み（2026-01-10）
- **内容**:
  - **画像フルスクリーン表示**: 添付画像タップでフルスクリーン表示（ピンチズーム・Heroアニメーション対応）
  - **閲覧中通知抑制**: チャット画面を開いている間は相手からの返信通知を抑制（通知スパム防止）
    - ユーザー画面オープン中 → 管理者返信の通知をスキップ
    - 管理者画面オープン中 → ユーザー返信の通知をスキップ
- **実装箇所**:
  - `lib/shared/widgets/full_screen_image_viewer.dart` - フルスクリーン画像表示ウィジェット
  - `lib/shared/services/inquiry_service.dart` - `setUserViewing`, `setAdminViewing` メソッド追加
  - `firebase/firestore.rules` - `userViewing` フィールド更新許可
  - `functions/src/index.ts` - `sendInquiryMessage`, `sendInquiryReply` に閲覧中チェック追加

### 16. 問い合わせ自動クリーンアップ ✅
- **優先度**: 中
- **状態**: ✅ 実装済み（2025-01-05確認）
- **設計書**: `docs/design/admin_features.md` セクション5.6.1, `docs/design/cleanup_processing_design.md`
- **内容**:
  - 解決済みから7日経過で自動削除
  - 削除対象: 問い合わせ本体 + メッセージ + 添付画像
  - `archivedInquiries`に1年間アーカイブ保存
  - 削除前日にユーザーへプッシュ通知

### 17. Googleスプレッドシート連携 ✅
- **優先度**: 中
- **状態**: ✅ 実装済み（2025-01-05確認）
- **設計書**: `docs/design/admin_features.md` セクション5.6.2
- **内容**:
  - 解決時にGoogle Sheets APIで自動追記
  - 保存項目: 日時, UID, カテゴリ, 件名, 内容, 解決日
  - 機能要望の長期管理に使用
- **必要設定**:
  - Google Cloud Console でサービスアカウント作成
  - Sheets API 有効化
  - Secret Manager にJSONキー登録

---

## 🤖 AI/Gemini API

### 15. Gemini APIエラー対策
- **優先度**: 高
- **状態**: ✅ 実装完了
- **内容**:
  - **OpenAI/Geminiフォールバック機能**:
    - `AIProviderFactory`クラスで両プロバイダーをサポート
    - Firestore設定（`settings/ai`）でプライマリプロバイダー切り替え可能
    - プライマリ失敗時に自動でフォールバック
  - **実装ファイル**: `functions/src/ai/provider.ts`
- **完了日**: 2025-12-26

---

## 🎨 UI全般

### 21. UI改善・全体ブラッシュアップ
- **優先度**: 高
- **状態**: 未着手（次回着手予定）
- **内容**:
  - 全体的なデザインの統一感向上
  - アニメーションの追加・調整（マイクロインタラクションの強化）
  - 各画面のパディング、マージン、フォントサイズの微調整
  - レスポンシブ対応の確認
  - ユーザー体験（UX）を向上させるための導線整理
  - 機能改修・追加完了後に着手予定

---

## 💰 マネタイズ

### 16. 広告表示
- **優先度**: 中
- **状態**: 未実装
- **内容**:
  - 基本は広告表示

### 17. サブスクリプション課金
- **優先度**: 中
- **状態**: 未実装
- **内容（要議論）**:

### 課金モデル（決定版）
| 無料 | サブスク（プレミアム） |
|------|----------------------|
| 全タスク機能 | 広告OFF |
| 基本名前パーツ | レア名前パーツ解放 |
| 基本アバター | 限定アバターパーツ |
| サークル参加 | サークル作成数増加 |
| - | **投稿装飾機能** |
| - | [プレミアム][課金者] バッジ |

### 投稿装飾機能（技術確認済み）
- **技術的に実装可能** ✅
- **実装方法**: `Stack` + `Positioned` widgetでカード角に装飾配置
- **装飾例**:
  - 王冠（プレミアムバッジ）
  - キラキラ（パーティクルエフェクト）
  - 豪華フレーム
  - 背景パターン

### 18. サブスク管理サービス検討
- **優先度**: 中
- **状態**: 検討中
- **候補**: RevenueCat
- **RevenueCatのメリット**:
  - iOS/Android両対応を統一管理
  - ダッシュボードで顧客・収益を可視化
  - 返金処理の自動追跡
  - Webhookでサーバー側と連携可能
  - 無料枠あり（月$2,500収益まで）
- **公式**: https://www.revenuecat.com/

### 19. BANユーザーのサブスク対応
- **優先度**: 高（サブスク実装時）
- **状態**: 方針決定済み
- **方針**:
  1. **BAN時**: 自動更新は停止されない（Google Playの仕様上、サーバーから強制解約不可）
  2. **機能制限**: サブスク有効でも投稿・コメント・リアクションは制限維持
  3. **サブスク特典の部分維持**: 広告非表示・閲覧機能は継続利用可能
  4. **ユーザーへの案内**: BAN時にサブスク解約を推奨するメッセージ表示
- **技術的制約**:
  - Google Play定期購読はサーバーから強制解約**不可**
  - 返金はGoogle Play Consoleから手動処理
- **利用規約への記載事項**:
  - 「規約違反によるアカウント制限時、サブスクリプションの返金は行いません」
  - 「制限中も閲覧機能はご利用いただけます」

---

## 📛 名前パーツ

### 18. アイコン位置の調整
- **優先度**: -（対応不要）
- **状態**: 現状維持に決定
- **内容**:
  - 現在のアイコン位置（真ん中）を維持

> [!NOTE]
> **議論点**: アイコンがあることで視覚的な識別性が上がり、他SNSとの差別化になる。
> 現状維持を推奨。

---

## 🔧 リファクタリング

### 19. サークルカテゴリ定義の統一 ✅
- **優先度**: -（対応完了）
- **状態**: ✅ 完了（2025-12-19）
- **内容**:
  - `circle_service.dart`, `circles_screen.dart`, `circle_detail_screen.dart` の3箇所に重複していたカテゴリ定義を `CircleService` に一本化
  - 変更時の修正箇所を1箇所に集約し、不整合（バグ）を防止
- **重複の原因**:
  - 初期開発段階で、一覧画面と詳細画面の実装が独立して進められた際、それぞれでカテゴリ用のMapを定義してしまい、共通のServiceを参照する設計になっていなかったため。


### 20. サークル一覧のUX改善（無限スクロール・Pull to Refresh） ✅
- **優先度**: 高
- **状態**: ✅ 実装済み（2025-12-24）
- **内容**:
  - **Pull to Refresh**: 一覧を下に引っ張って更新する機能を追加
  - **無限スクロール**: スクロール最下部で自動的に次の件数を読み込む機能を追加
  - **タブ切替時の自動更新**: カテゴリタブを切り替えた際にリストをリフレッシュ
- **実装箇所**:
  - `circle_service.dart`: `getPublicCircles`にページネーション対応（`lastDocument`, `limit`）
- `circles_screen.dart`: `RefreshIndicator`, `ScrollController`による制御

---

## 👥 サークル

### 1. ピン留め状態の不整合（一覧とピン留め一覧で差異）
- **優先度**: 中
- **状態**: ⬜ 未着手
- **問題**:
  - ピン留め一覧で解除した投稿が、投稿一覧の三点メニューでは「ピン留め解除」表示のままになることがある
- **再現手順**:
  1. 投稿一覧から任意の投稿をピン留め
  2. もう1つ投稿をピン留めし、ピン留めが複数の状態にする
  3. ピン留め一覧を開き、三点メニューでピン留め解除
  4. 投稿一覧で該当投稿の三点メニューを開く
  5. 解除済みにもかかわらず「ピン留め解除」が表示される
- **期待値**:
  - ピン留め解除後、投稿一覧側の状態も即時で同期される

### 2. 投稿詳細画面からピン留め操作ができない（UX）
- **優先度**: 低
- **状態**: ⬜ 未着手
- **問題**:
  - 投稿詳細画面からピン留め/解除ができず、一覧に戻って対象投稿を探す必要がある
- **期待値**:
  - 投稿詳細画面でもピン留め/解除が可能

---


### 21. 通報通知の遷移先修正
- **優先度**: 高
- **状態**: 🔄 修正中
- **問題**:
  - 新規通報のプッシュ通知をタップすると、旧通報詳細画面（通報者単位）に遷移してしまう
  - 本来は新通報詳細画面（コンテンツ単位）に遷移すべき
- **原因**:
  - バックエンド(`reports.ts`)からの通知ペイロードに `contentId` が含まれていないため、アプリ側(`main.dart`)が旧画面への遷移判定を行っている
- **修正案**:
  - `functions/src/callable/reports.ts` の `admin_report` 通知作成処理に `contentId` を追加する

### 22. 旧通報画面のコード削除
- **優先度**: 低（修正後）
- **状態**: ⬜ 未着手
- **内容**:
  - 通報詳細画面（`AdminReportDetailScreen`）は現在「投稿単位」での管理に移行しており、不要となっている
  - 上記の通知遷移修正完了後、`AdminReportDetailScreen` および関連するルーティングを削除する

---

## 🔒 セキュリティ

### 23. Firebase App Check の有効化
- **優先度**: 中
- **状態**: ⬜ 未着手
- **問題**:
  - 現在 App Check は enforcement=disabled で動作しており、すべての Callable 関数で警告ログが発生
  - `Callable request verification failed: AppCheck token was rejected.`
  - `Allowing request with invalid AppCheck token because enforcement is disabled`
- **内容**:
  - Firebase コンソールで App Check を有効化
  - Android: Play Integrity API または SafetyNet 設定
  - iOS: DeviceCheck または App Attest 設定
  - Cloud Functions で App Check enforcement を有効化
  - テスト環境用のデバッグトークン設定
- **参考**: https://firebase.google.com/docs/app-check
- **追加日**: 2026-01-14

---

## 🚫 BAN機能（2026-01-14 追加）

### 24. 被BANユーザーチャット画面に戻るボタンがない
- **優先度**: 高
- **状態**: ⬜ 未着手
- **問題**:
  - 被BANユーザーが運営とのチャット画面を開くと、戻るボタンがない
  - ユーザーがアプリ内で戻る手段がない
- **内容**:
  - BANチャット画面（ban_appeal_chat_screen.dart）にAppBarと戻るボタンを追加
  - マイページへ戻れるようにする
- **追加日**: 2026-01-14

### 25. 永久BANユーザーのログイン挙動改善
- **優先度**: 高
- **状態**: ⬜ 未着手
- **問題**:
  - 現在、永久BANユーザーは Firebase Auth が disabled になりログイン自体ができない
  - 「ごめんね、うまくいかなかったみたい」というエラーが表示される
- **理想的な挙動**:
  - 永久BANでもログインは許可する
  - ログイン後はマイページと運営チャット画面のみ表示
  - BAN理由の確認、異議申し立て、データ確認が可能
- **実装案**:
  1. `permanentBanUser` から `auth().updateUser(disabled: true)` を削除
  2. `banStatus: "permanent"` のみでFirestore側で判定
  3. アプリ側でルーティング制御（マイページ + BANチャットのみ）
  4. 180日後の削除処理はそのまま維持
- **追加日**: 2026-01-14

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-12-18 | 初版作成 |
| 2026-01-10 | 問い合わせチャットUX改善を追加、設計書リンク追加 |
| 2026-01-13 | 通報通知の遷移先修正、旧画面削除を追加 |
| 2026-01-14 | App Check有効化を追加、BAN機能改善2件追加 |



---

##  サークル機能（2026-01-29 追加）

### 26. サークルフィルターに招待制/公開選択を追加
- **優先度**: 中
- **状態**:  未着手
- **内容**:
  - サークル一覧画面のフィルターに「招待制」「公開」を選択できる項目を追加
  - ユーザーが参加可能なサークルを絞り込みやすくする
- **実装箇所**: `circles_screen.dart`, `circle_service.dart`
- **追加日**: 2026-01-29

---

##  UI/UX（2026-01-29 追加）

### 27. タスク画面のステータスバー表示問題
- **優先度**: 中
- **状態**:  未着手
- **問題**:
  - タスク画面に遷移すると、スマホの通知領域と背景が同じ色でかぶる
  - ステータスバーの通知アイコンが見えなくなる
- **修正内容**:
  - ステータスバーのアイコン色を背景色に応じて調整（明るい背景  暗いアイコン）
  - `SystemUiOverlayStyle` で適切な設定を行う
- **実装箇所**: `tasks_screen.dart`
- **追加日**: 2026-01-29
