rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ユーザー認証チェック
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // 本人かどうかチェック
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // BANされていないかチェック
    function isNotBanned() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isBanned == false;
    }
    
    // ユーザーコレクション
    match /users/{userId} {
      // 読み取り: 認証済みユーザー
      allow read: if isAuthenticated();
      
      // 作成: 本人のみ
      allow create: if isAuthenticated() && isOwner(userId);
      
      // 更新: 本人のみ（特定フィールドは変更不可）
      allow update: if isAuthenticated() && isOwner(userId) && 
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['virtue', 'isBanned', 'isAI', 'createdAt']);

      // 通知サブコレクション
      match /notifications/{notificationId} {
         allow read: if isAuthenticated() && isOwner(userId);
         allow update: if isAuthenticated() && isOwner(userId); // 既読更新用
         allow delete: if isAuthenticated() && isOwner(userId); // 削除用
         allow create: if false; // サーバー側でのみ作成
      }

      // カテゴリサブコレクション
      match /categories/{categoryId} {
         allow read, write: if isAuthenticated() && isOwner(userId);
      }
    }

    // タスクコレクション
    match /tasks/{taskId} {
      // 読み取り: 本人のみ
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // 作成: 本人のみ
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // 更新: 本人のみ
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // 削除: 本人のみ (存在しないドキュメントの削除も許可してエラーを防ぐ)
      allow delete: if isAuthenticated() && (resource == null || resource.data.userId == request.auth.uid);
    }

    // 目標コレクション
    match /goals/{goalId} {
      // 読み取り: 本人 または 公開設定がtrueの場合
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || resource.data.isPublic == true);
      
      // 作成: 本人のみ
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // 更新: 本人のみ
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // 削除: 本人のみ
      allow delete: if isAuthenticated() && (resource == null || resource.data.userId == request.auth.uid);
    }
    
    // 投稿コレクション
    match /posts/{postId} {
      // 読み取り: 認証済みユーザー
      allow read: if isAuthenticated();
      
      // 作成: 認証済みでBANされていないユーザー
      // 作成: クライアントからの直接作成を禁止（Cloud Functions経由のみ）
      allow create: if false;
      
      // 更新: 投稿者のみ（リアクションは誰でも更新可能）
      allow update: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions', 'commentCount'])
      );
      
      // 削除: 投稿者 または サークル投稿の場合はサークルオーナーも可
      allow delete: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        (resource.data.circleId != null && 
         exists(/databases/$(database)/documents/circles/$(resource.data.circleId)) &&
         get(/databases/$(database)/documents/circles/$(resource.data.circleId)).data.ownerId == request.auth.uid)
      );
    }
    
    // コメントコレクション
    match /comments/{commentId} {
      // 読み取り: 認証済みユーザー
      allow read: if isAuthenticated();
      
      // 作成: 認証済みでBANされていないユーザー
      allow create: if isAuthenticated() && isNotBanned() && 
        request.resource.data.userId == request.auth.uid;
      
      // 削除: コメント投稿者 または 元投稿の所有者 または サークルオーナー
      allow delete: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        isOwner(get(/databases/$(database)/documents/posts/$(resource.data.postId)).data.userId) ||
        (get(/databases/$(database)/documents/posts/$(resource.data.postId)).data.circleId != null &&
         get(/databases/$(database)/documents/circles/$(get(/databases/$(database)/documents/posts/$(resource.data.postId)).data.circleId)).data.ownerId == request.auth.uid)
      );
    }
    
    // リアクションコレクション
    match /reactions/{reactionId} {
      // 読み取り: 認証済みユーザー
      allow read: if isAuthenticated();
      
      // 作成: 認証済みでBANされていないユーザー
      allow create: if isAuthenticated() && isNotBanned() && 
        request.resource.data.userId == request.auth.uid;
      
      // 削除: リアクションした本人 または 元投稿の所有者 または サークルオーナー
      allow delete: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        isOwner(get(/databases/$(database)/documents/posts/$(resource.data.postId)).data.userId) ||
        (get(/databases/$(database)/documents/posts/$(resource.data.postId)).data.circleId != null &&
         get(/databases/$(database)/documents/circles/$(get(/databases/$(database)/documents/posts/$(resource.data.postId)).data.circleId)).data.ownerId == request.auth.uid)
      );
    }

    // サークルコレクション
    match /circles/{circleId} {
      // 読み取り: 認証済みユーザーは誰でも（クライアント側でフィルタリング）
      allow read: if isAuthenticated();
      
      // 作成: 認証済みでBANされていないユーザー
      allow create: if isAuthenticated() && isNotBanned();
      
      // 更新: オーナーまたはメンバー追加・削除操作
      allow update: if isAuthenticated() && (
        isOwner(resource.data.ownerId) ||
        // メンバー追加・削除（自分自身のみ）
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['memberIds', 'memberCount']) &&
         (request.auth.uid in request.resource.data.memberIds || request.auth.uid in resource.data.memberIds))
      );
      
      // 削除: オーナーのみ
      allow delete: if isAuthenticated() && isOwner(resource.data.ownerId);
    }
    
    // サークル参加申請コレクション
    match /circleJoinRequests/{requestId} {
      // 読み取り: サークルオーナーまたは申請者
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        get(/databases/$(database)/documents/circles/$(resource.data.circleId)).data.ownerId == request.auth.uid
      );
      
      // 作成: 認証済みユーザー
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // 更新: サークルオーナーのみ（承認/拒否）
      allow update: if isAuthenticated() && 
        get(/databases/$(database)/documents/circles/$(resource.data.circleId)).data.ownerId == request.auth.uid;
      
      // 削除: 申請者またはサークルオーナー
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        get(/databases/$(database)/documents/circles/$(resource.data.circleId)).data.ownerId == request.auth.uid
      );
    }
    
    // 通報コレクション
    match /reports/{reportId} {
      // 作成のみ許可（Cloud Functionsで処理）
      allow read: if false;
      allow create: if false;
    }
    
    // 徳ポイント履歴コレクション
    match /virtueHistory/{historyId} {
      // 読み取り: 本人のみ
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // 書き込み: Cloud Functionsのみ
      allow write: if false;
    }
    
    // モデレーション済みコンテンツ（管理用）
    match /moderatedContent/{contentId} {
      // すべてCloud Functionsで管理
      allow read, write: if false;
    }
  }
}


