rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ユーザー認証チェック
    function isAuthenticated() {
      return request.auth != null;
    }

    // 本人かどうかチェック
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // BANされていないかチェック（より厳密に）
    // isBannedやbanStatusが存在しない場合はBANされていないとみなす
    function isNotBanned() {
      let userData = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      return (userData.isBanned == null || userData.isBanned == false) && 
             (userData.banStatus == null || userData.banStatus == 'none');
    }

    // 管理者チェック（Custom Claims使用）
    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }

    // サークルの副オーナーチェック
    function isCircleSubOwner(circleId) {
      return exists(/databases/$(database)/documents/circles/$(circleId)) &&
             get(/databases/$(database)/documents/circles/$(circleId)).data.subOwnerId == request.auth.uid;
    }

    // サークルのオーナーまたは副オーナーチェック
    function isCircleOwnerOrSubOwner(circleId) {
      let circleData = get(/databases/$(database)/documents/circles/$(circleId)).data;
      return circleData.ownerId == request.auth.uid || circleData.subOwnerId == request.auth.uid;
    }

    // サークルのオーナー、副オーナー、または管理者チェック
    function isCircleOwnerOrSubOwnerOrAdmin(circleId) {
      return isAdmin() || isCircleOwnerOrSubOwner(circleId);
    }
    
    // ユーザーコレクション
    match /users/{userId} {
      // 読み取り: 認証済みユーザー
      allow read: if isAuthenticated();
      
      // 作成: 本人のみ
      allow create: if isAuthenticated() && isOwner(userId);
      
      // 更新: 本人のみ（特定フィールドは変更不可）
      allow update: if isAuthenticated() && isOwner(userId) && 
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['virtue', 'isBanned', 'banStatus', 'banHistory', 'permanentBanScheduledDeletionAt', 'warningCount', 'isAI', 'createdAt']);

      // カテゴリサブコレクション
      match /categories/{categoryId} {
        allow read: if isAuthenticated() && isOwner(userId);
        allow create: if isAuthenticated() && isOwner(userId);
        allow update: if isAuthenticated() && isOwner(userId);
        allow delete: if isAuthenticated() && isOwner(userId);
      }

      // 通知サブコレクション
      match /notifications/{notificationId} {
         allow read: if isAuthenticated() && isOwner(userId);
         allow update: if isAuthenticated() && isOwner(userId); // 既読更新用
         allow delete: if isAuthenticated() && isOwner(userId); // 削除用
         // 管理者は通知を作成可能
         allow create: if isAdmin();
      }
    }
    
    // BAN異議申し立てコレクション
    match /banAppeals/{appealId} {
      // 読み取り: 管理者 または 本人
      allow read: if isAuthenticated() && (
        isAdmin() || 
        resource.data.bannedUserId == request.auth.uid
      );
      
      // 作成: 管理者 または 本人
      allow create: if isAuthenticated() && (
        isAdmin() || 
        request.resource.data.bannedUserId == request.auth.uid
      );
      
      // 更新: 管理者 または 本人
      allow update: if isAuthenticated() && (
        isAdmin() || 
        resource.data.bannedUserId == request.auth.uid
      );
    }
    
    // 投稿コレクション
    match /posts/{postId} {
      // 読み取り: 認証済みユーザー（非表示フラグを考慮すべきだが、クライアント側フィルタリングも併用）
      // BANされていても読み取りは許可（一時BANユーザーは別途クライアント側で制限）
      // ただし永久BANの場合はログアウトさせるので考慮不要
      allow read: if isAuthenticated();
      
      // 作成: 認証済み かつ BANされていない
      // クライアントからの直接作成は禁止 (Cloud Functions経由) だが、
      // 管理者機能などで直接書き込む場合に備えてルールは定義しておく
      allow create: if false; 
      
      // 更新: 投稿者本人（BANされていない）または管理者、サークルオーナー（ピン留め等）
      // ここでは簡易的に本人のみ＋BANチェック。ピン留めは別途考慮が必要だが、
      // togglePinなどはCloud Functions経由か、またはフィールド制限が必要。
      // togglePinはCircleServiceでupdateを使っているので、ここで許可が必要。
      allow update: if isAuthenticated() && (
        (resource.data.userId == request.auth.uid && isNotBanned()) ||
        isAdmin() ||
        (resource.data.circleId != null && isCircleOwnerOrSubOwner(resource.data.circleId)) // ピン留め用
      );
      
      // 削除: 投稿者本人（BANされていない）または管理者
      allow delete: if isAuthenticated() && (
        (resource.data.userId == request.auth.uid && isNotBanned()) ||
        isAdmin() || 
        (resource.data.circleId != null && isCircleOwnerOrSubOwner(resource.data.circleId)) // サークルオーナー権限
      );
      
      // リアクションサブコレクション
      match /reactions/{reactionId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && isNotBanned() && request.resource.data.userId == request.auth.uid;
        allow delete: if isAuthenticated() && isNotBanned() && resource.data.userId == request.auth.uid;
      }
      
      // コメントサブコレクション
      match /comments/{commentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && isNotBanned(); // ※Cloud Functions経由でつくるなら `if false` だが、直接なら `isNotBanned()`
        allow update: if isAuthenticated() && isNotBanned() && resource.data.userId == request.auth.uid;
        allow delete: if isAuthenticated() && (
          (resource.data.userId == request.auth.uid && isNotBanned()) || 
          isAdmin() ||
          // サークルオーナーはコメントも消せる？ 設計書要確認 → 「他者投稿削除は管理者のみ」とあるが、コメントは？
          // 一般的にサークルオーナーは荒らしコメントを消せると便利。
          // ここでは一旦、本人と管理者のみ許可。
          false
        );
      }
    }

    // サークルコレクション
    match /circles/{circleId} {
      // 読み取り: 認証済み
      allow read: if isAuthenticated();
      
      // 作成: 認証済み かつ BANされていない
      allow create: if isAuthenticated() && isNotBanned();
      
      // 更新: オーナー または 管理者（BANされていてもオーナー権限は維持？ -> 一時BANなら維持。永久BANならCloud Functionsで剥奪）
      // 一時BAN中にサークル編集を許可するか？ -> 設計書「サークル不可」とあるので禁止すべき
      allow update: if isAuthenticated() && (
        (isOwner(resource.data.ownerId) && isNotBanned()) ||
        isAdmin()
      );
      
      // 削除: オーナー または 管理者
      allow delete: if isAuthenticated() && (
        (isOwner(resource.data.ownerId) && isNotBanned()) ||
        isAdmin()
      );
    }
    
    // サークル参加申請コレクション
    match /circleJoinRequests/{requestId} {
      // 読み取り: サークルオーナー、副オーナー、管理者、または申請者
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isCircleOwnerOrSubOwnerOrAdmin(resource.data.circleId)
      );
      
      // 作成: 認証済みユーザー & BANされていない
      allow create: if isAuthenticated() && isNotBanned() && request.resource.data.userId == request.auth.uid;
      
      // 更新: サークルオーナーまたは副オーナーまたは管理者（承認/拒否）
      // BAN中のオーナー/副オーナーは操作不可にする
      allow update: if isAuthenticated() && isNotBanned() &&
        isCircleOwnerOrSubOwnerOrAdmin(resource.data.circleId);
      
      // 削除: 申請者またはサークルオーナー/副オーナー/管理者
      allow delete: if isAuthenticated() && isNotBanned() && (
        resource.data.userId == request.auth.uid ||
        isCircleOwnerOrSubOwnerOrAdmin(resource.data.circleId)
      );
    }


    // タスクコレクション
    match /tasks/{taskId} {
      // 読み取り: 本人のみ
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // 作成: 本人のみ
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // 更新: 本人のみ
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // 削除: 本人のみ (存在しないドキュメントの削除も許可してエラーを防ぐ)
      allow delete: if isAuthenticated() && (resource == null || resource.data.userId == request.auth.uid);
    }

    // 目標コレクション
    match /goals/{goalId} {
      // 読み取り: 本人 または 公開設定がtrueの場合
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || resource.data.isPublic == true);
      
      // 作成: 本人のみ
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // 更新: 本人のみ
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // 削除: 本人のみ
      allow delete: if isAuthenticated() && (resource == null || resource.data.userId == request.auth.uid);
    }
    
    // 投稿コレクション
    match /posts/{postId} {
      // 読み取り: 認証済みユーザー
      allow read: if isAuthenticated();
      
      // 作成: 認証済みでBANされていないユーザー
      // 作成: クライアントからの直接作成を禁止（Cloud Functions経由のみ）
      allow create: if false;
      
      // 更新: 投稿者のみ（リアクションは誰でも更新可能、サークルオーナー/副オーナーはピン留めも可能、管理者はneedsReview）
      allow update: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions', 'commentCount']) ||
        // サークルオーナーまたは副オーナーはピン留めフィールドを更新可能
        (resource.data.circleId != null &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isPinned', 'isPinnedTop']) &&
         exists(/databases/$(database)/documents/circles/$(resource.data.circleId)) &&
         isCircleOwnerOrSubOwner(resource.data.circleId)) ||
        // 管理者は全ての更新が可能
        isAdmin()
      );

      // 削除: 投稿者 または サークル投稿の場合はサークルオーナーも可、管理者は削除可能
      allow delete: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        (resource.data.circleId != null &&
         exists(/databases/$(database)/documents/circles/$(resource.data.circleId)) &&
         get(/databases/$(database)/documents/circles/$(resource.data.circleId)).data.ownerId == request.auth.uid) ||
        isAdmin()
      );
    }
    
    // コメントコレクション
    match /comments/{commentId} {
      // 読み取り: 認証済みユーザー
      allow read: if isAuthenticated();
      
      // 作成: 認証済みでBANされていないユーザー
      allow create: if isAuthenticated() && isNotBanned() && 
        request.resource.data.userId == request.auth.uid;
      
      // 削除: コメント投稿者 または 元投稿の所有者 または サークルオーナー または 管理者
      allow delete: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        isOwner(get(/databases/$(database)/documents/posts/$(resource.data.postId)).data.userId) ||
        (get(/databases/$(database)/documents/posts/$(resource.data.postId)).data.circleId != null &&
         get(/databases/$(database)/documents/circles/$(get(/databases/$(database)/documents/posts/$(resource.data.postId)).data.circleId)).data.ownerId == request.auth.uid) ||
        isAdmin()
      );
    }
    
    // リアクションコレクション
    match /reactions/{reactionId} {
      // 読み取り: 認証済みユーザー
      allow read: if isAuthenticated();
      
      // 作成: 認証済みでBANされていないユーザー
      allow create: if isAuthenticated() && isNotBanned() && 
        request.resource.data.userId == request.auth.uid;
      
      // 削除: リアクションした本人 または 元投稿の所有者 または サークルオーナー または 管理者
      allow delete: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        isOwner(get(/databases/$(database)/documents/posts/$(resource.data.postId)).data.userId) ||
        (get(/databases/$(database)/documents/posts/$(resource.data.postId)).data.circleId != null &&
         get(/databases/$(database)/documents/circles/$(get(/databases/$(database)/documents/posts/$(resource.data.postId)).data.circleId)).data.ownerId == request.auth.uid) ||
        isAdmin()
      );
    }

    // サークルコレクション
    match /circles/{circleId} {
      // 読み取り: 認証済みユーザーは誰でも（クライアント側でフィルタリング）
      allow read: if isAuthenticated();
      
      // 作成: 認証済みでBANされていないユーザー（管理者はBANチェックスキップ）
      allow create: if isAuthenticated() && (isNotBanned() || isAdmin());
      
      // 更新: オーナー、または管理者、またはメンバー追加・削除操作、またはメンバーによるpostCount更新
      allow update: if isAuthenticated() && (
        isOwner(resource.data.ownerId) ||
        isAdmin() ||
        // メンバー追加・削除（自分自身のみ）
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['memberIds', 'memberCount']) &&
         (request.auth.uid in request.resource.data.memberIds || request.auth.uid in resource.data.memberIds)) ||
        // 副オーナー退会時のsubOwnerIdクリア（自分が副オーナーで退会する場合）
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['memberIds', 'memberCount', 'subOwnerId']) &&
         resource.data.subOwnerId == request.auth.uid &&
         request.resource.data.subOwnerId == null &&
         request.auth.uid in resource.data.memberIds &&
         !(request.auth.uid in request.resource.data.memberIds)) ||
        // postCount更新（メンバーのみ）
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['postCount']) &&
         request.auth.uid in resource.data.memberIds)
      );
      
      // 削除: オーナーまたは管理者のみ
      allow delete: if isAuthenticated() && (isOwner(resource.data.ownerId) || isAdmin());
    }
    
    // サークル参加申請コレクション
    match /circleJoinRequests/{requestId} {
      // 読み取り: サークルオーナー、副オーナー、管理者、または申請者
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isCircleOwnerOrSubOwnerOrAdmin(resource.data.circleId)
      );
      
      // 作成: 認証済みユーザー
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // 更新: 注意! isCircleOwnerOrSubOwnerOrAdmin は circleId を引数に取るが、
      // ここでは resource.data.circleId を使う必要がある。
      // サークルオーナーまたは副オーナーまたは管理者（承認/拒否）
      allow update: if isAuthenticated() && 
        isCircleOwnerOrSubOwnerOrAdmin(resource.data.circleId);
      
      // 削除: 申請者またはサークルオーナー/副オーナー/管理者
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isCircleOwnerOrSubOwnerOrAdmin(resource.data.circleId)
      );
    }
    
    
    // 徳ポイント履歴コレクション
    match /virtueHistory/{historyId} {
      // 読み取り: 本人のみ
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // 書き込み: Cloud Functionsのみ
      allow write: if false;
    }
    
    // モデレーション済みコンテンツ（管理用）
    match /moderatedContent/{contentId} {
      // すべてCloud Functionsで管理
      allow read, write: if false;
    }

    // 問い合わせコレクション
    match /inquiries/{inquiryId} {
      // 読み取り: 管理者は全件、ユーザーは自分のみ
      allow read: if isAuthenticated() && (
        isAdmin() ||
        resource.data.userId == request.auth.uid
      );

      // 更新: 本人（hasUnreadReply）または管理者
      allow update: if isAuthenticated() && (
        isAdmin() ||
        (resource.data.userId == request.auth.uid &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['hasUnreadReply']))
      );

      // 作成・削除: Cloud Functionsのみ
      allow create, delete: if false;

      // メッセージサブコレクション
      match /messages/{messageId} {
        // 読み取り: 管理者または問い合わせオーナー
        allow read: if isAuthenticated() && (
          isAdmin() ||
          get(/databases/$(database)/documents/inquiries/$(inquiryId)).data.userId == request.auth.uid
        );
        // 書き込み: Cloud Functionsのみ
        allow create, delete: if false;
      }
    }

    // BAN異議申し立てチャットコレクション
    match /ban_appeals/{appealId} {
      // 読み取り: 管理者または該当ユーザー
      allow read: if isAuthenticated() && (
        isAdmin() ||
        resource.data.bannedUserId == request.auth.uid
      );
      
      // 作成: 該当ユーザー（BANされていても作成可能）
      allow create: if isAuthenticated() && 
        request.resource.data.bannedUserId == request.auth.uid;
      
      // 更新: 管理者または該当ユーザー（メッセージ追加）
      allow update: if isAuthenticated() && (
        isAdmin() ||
        resource.data.bannedUserId == request.auth.uid
      );
      
      // 削除: 管理者のみ
      allow delete: if isAdmin();
    }

    // banAppealsコレクション（別名）
    match /banAppeals/{appealId} {
      // 読み取り: 管理者または該当ユーザー
      allow read: if isAuthenticated() && (
        isAdmin() ||
        resource.data.bannedUserId == request.auth.uid
      );
      
      // 作成: 該当ユーザー（BANされていても作成可能）
      allow create: if isAuthenticated() && 
        request.resource.data.bannedUserId == request.auth.uid;
      
      // 更新: 管理者または該当ユーザー（メッセージ追加）
      allow update: if isAuthenticated() && (
        isAdmin() ||
        resource.data.bannedUserId == request.auth.uid
      );
      
      // 削除: 管理者のみ
      allow delete: if isAdmin();
    }

    // 通報コレクション
    match /reports/{reportId} {
      // 管理者のみ読み取り可能
      allow read: if isAdmin();
      // 管理者のみ更新可能（ステータス変更）
      allow update: if isAdmin();
      // 作成・削除はCloud Functionsのみ
      allow create, delete: if false;
    }

    // 要審査投稿コレクション（管理者専用）
    match /pendingReviews/{reviewId} {
      // 管理者のみ読み取り可能
      allow read: if isAdmin();
      // 管理者のみ更新可能（承認/削除後の状態更新）
      allow update: if isAdmin();
      // 作成・削除はCloud Functionsのみ
      allow create, delete: if false;
    }
  }
}


