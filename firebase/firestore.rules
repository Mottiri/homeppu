rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ユーザー認証チェック
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // 本人かどうかチェック
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // BANされていないかチェック
    function isNotBanned() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isBanned == false;
    }
    
    // ユーザーコレクション
    match /users/{userId} {
      // 読み取り: 認証済みユーザー
      allow read: if isAuthenticated();
      
      // 作成: 本人のみ
      allow create: if isAuthenticated() && isOwner(userId);
      
      // 更新: 本人のみ（特定フィールドは変更不可）
      allow update: if isAuthenticated() && isOwner(userId) && 
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['virtue', 'isBanned', 'isAI', 'createdAt']);

      // 通知サブコレクション
      match /notifications/{notificationId} {
         allow read: if isAuthenticated() && isOwner(userId);
         allow update: if isAuthenticated() && isOwner(userId); // 既読更新用
         allow delete: if isAuthenticated() && isOwner(userId); // 削除用
         allow create: if false; // サーバー側でのみ作成
      }

      // カテゴリサブコレクション
      match /categories/{categoryId} {
         allow read, write: if isAuthenticated() && isOwner(userId);
      }
    }

    // タスクコレクション
    match /tasks/{taskId} {
      // 読み取り: 本人のみ
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // 作成: 本人のみ
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // 更新: 本人のみ
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // 削除: 本人のみ
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // 投稿コレクション
    match /posts/{postId} {
      // 読み取り: 認証済みユーザー
      allow read: if isAuthenticated();
      
      // 作成: 認証済みでBANされていないユーザー
      allow create: if isAuthenticated() && isNotBanned() && 
        request.resource.data.userId == request.auth.uid;
      
      // 更新: 投稿者のみ（リアクションは誰でも更新可能）
      allow update: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions', 'commentCount'])
      );
      
      // 削除: 投稿者のみ
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }
    
    // コメントコレクション
    match /comments/{commentId} {
      // 読み取り: 認証済みユーザー
      allow read: if isAuthenticated();
      
      // 作成: 認証済みでBANされていないユーザー
      allow create: if isAuthenticated() && isNotBanned() && 
        request.resource.data.userId == request.auth.uid;
      
      // 削除: コメント投稿者 または 元投稿の所有者
      allow delete: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        isOwner(get(/databases/$(database)/documents/posts/$(resource.data.postId)).data.userId)
      );
    }
    
    // リアクションコレクション
    match /reactions/{reactionId} {
      // 読み取り: 認証済みユーザー
      allow read: if isAuthenticated();
      
      // 作成: 認証済みでBANされていないユーザー
      allow create: if isAuthenticated() && isNotBanned() && 
        request.resource.data.userId == request.auth.uid;
      
      // 削除: リアクションした本人 または 元投稿の所有者
      allow delete: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        isOwner(get(/databases/$(database)/documents/posts/$(resource.data.postId)).data.userId)
      );
    }

    // サークルコレクション
    match /circles/{circleId} {
      // 読み取り: 公開サークルは誰でも、非公開はメンバーのみ
      allow read: if isAuthenticated() && (
        resource.data.isPublic == true ||
        request.auth.uid in resource.data.memberIds
      );
      
      // 作成: 認証済みでBANされていないユーザー
      allow create: if isAuthenticated() && isNotBanned();
      
      // 更新: オーナーのみ（メンバー追加は別途）
      allow update: if isAuthenticated() && isOwner(resource.data.ownerId);
      
      // 削除: オーナーのみ
      allow delete: if isAuthenticated() && isOwner(resource.data.ownerId);
    }
    
    // 通報コレクション
    match /reports/{reportId} {
      // 作成のみ許可（Cloud Functionsで処理）
      allow read: if false;
      allow create: if false;
    }
    
    // 徳ポイント履歴コレクション
    match /virtueHistory/{historyId} {
      // 読み取り: 本人のみ
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // 書き込み: Cloud Functionsのみ
      allow write: if false;
    }
    
    // モデレーション済みコンテンツ（管理用）
    match /moderatedContent/{contentId} {
      // すべてCloud Functionsで管理
      allow read, write: if false;
    }
  }
}


